<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Macaron Guild Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        
        /* Chart Container Styling */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #fbcfe8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #f472b6; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Sortable Header Cursor */
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 h-screen overflow-hidden flex">

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 z-50 w-64 bg-white border-r border-gray-200 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col">
        <div class="p-6 border-b border-gray-100 flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-pink-400 to-rose-400 flex items-center justify-center text-white font-bold">
                M
            </div>
            <span class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-rose-500">
                Macaron Guild
            </span>
            <button id="closeSidebar" class="lg:hidden ml-auto text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <nav class="p-4 space-y-2 flex-1">
            <button onclick="router('dashboard')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50" data-target="dashboard">
                <i class="fas fa-coffee w-5 text-center"></i>
                <span class="font-medium">대시보드</span>
            </button>
            <button onclick="router('members')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50" data-target="members">
                <i class="fas fa-users w-5 text-center"></i>
                <span class="font-medium">길드원 관리</span>
            </button>
            <button onclick="router('history')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50" data-target="history">
                <i class="fas fa-history w-5 text-center"></i>
                <span class="font-medium">가입/탈퇴 이력</span>
            </button>
            <button onclick="router('settings')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50" data-target="settings">
                <i class="fas fa-cog w-5 text-center"></i>
                <span class="font-medium">설정</span>
            </button>
        </nav>

        <div class="p-4 border-t border-gray-100 bg-gray-50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center">
                    <i class="fas fa-user-shield text-gray-500"></i>
                </div>
                <div>
                    <p class="text-sm font-bold">관리자</p>
                    <p class="text-xs text-gray-500">Full Access Mode</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Overlay -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/20 z-40 hidden lg:hidden"></div>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden bg-gray-50">
        <!-- Header -->
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 shrink-0">
            <div class="flex items-center gap-4">
                <button id="openSidebar" class="p-2 lg:hidden rounded-lg hover:bg-gray-100 text-gray-600">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h1 id="pageTitle" class="text-xl font-bold text-gray-800">길드 현황판</h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="hidden md:flex px-3 py-1 bg-pink-50 text-pink-600 rounded-full text-sm font-medium">
                    ✨ 전체 인원: <span id="totalMembersCount">0</span>명
                </div>
            </div>
        </header>

        <!-- Dynamic Content Area -->
        <div id="contentArea" class="flex-1 overflow-y-auto p-4 lg:p-8 relative">
            <!-- Content injected by JS -->
        </div>
    </main>

    <!-- Modals -->
    <!-- Member Form Modal -->
    <div id="memberModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden transform scale-100 transition-all">
            <div class="p-4 bg-pink-50 border-b border-pink-100 flex justify-between items-center">
                <h3 id="modalTitle" class="font-bold text-pink-700 flex items-center gap-2">
                    <i class="fas fa-user-plus"></i> 멤버 등록
                </h3>
                <button onclick="closeModal('memberModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <form id="memberForm" class="p-6 space-y-4">
                <input type="hidden" id="editMemberId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">닉네임</label>
                    <input type="text" id="inputName" class="w-full border border-gray-200 rounded-lg p-2 focus:ring-2 focus:ring-pink-500 outline-none" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">길드</label>
                        <select id="inputGuild" class="w-full border border-gray-200 rounded-lg p-2 focus:ring-2 focus:ring-pink-500 outline-none" onchange="onGuildSelectChange(this.value)"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">직위</label>
                        <select id="inputRole" class="w-full border border-gray-200 rounded-lg p-2 focus:ring-2 focus:ring-pink-500 outline-none"></select>
                    </div>
                </div>
                <!-- Level Input Removed -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">직업</label>
                    <input type="text" id="inputClass" class="w-full border border-gray-200 rounded-lg p-2 focus:ring-2 focus:ring-pink-500 outline-none" placeholder="예: 비숍, 아델">
                </div>
                <div class="flex items-center gap-2 pt-2">
                    <input type="checkbox" id="inputIsMain" class="w-4 h-4 text-pink-600 rounded focus:ring-pink-500" checked onchange="toggleMainCharInput()">
                    <label for="inputIsMain" class="text-sm font-medium text-gray-700">본캐릭터 여부</label>
                </div>
                <div id="mainCharInputGroup" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">본캐 닉네임</label>
                    <input type="text" id="inputMainCharName" class="w-full border border-gray-200 rounded-lg p-2 focus:ring-2 focus:ring-pink-500 outline-none" placeholder="본캐 닉네임을 입력하세요">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">가입일</label>
                    <input type="date" id="inputJoinDate" class="w-full border border-gray-200 rounded-lg p-2 focus:ring-2 focus:ring-pink-500 outline-none">
                </div>
                <button type="submit" class="w-full bg-pink-500 text-white py-3 rounded-lg font-bold hover:bg-pink-600 transition-colors mt-2 shadow-lg shadow-pink-200">
                    저장하기
                </button>
            </form>
        </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div id="bulkModal" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl overflow-hidden flex flex-col h-[90vh]">
            <div class="p-4 bg-green-50 border-b border-green-100 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-green-700 flex items-center gap-2">
                    <i class="fas fa-file-excel"></i> 엑셀/시트 붙여넣기 (일괄 등록)
                </h3>
                <button onclick="closeModal('bulkModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 flex-1 overflow-y-auto flex flex-col">
                <!-- Instructions -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-4 text-sm text-gray-600 space-y-2">
                    <div class="flex justify-between items-start">
                        <p class="font-bold text-gray-800"><i class="fas fa-info-circle text-green-500 mr-1"></i> 사용 방법</p>
                        <button onclick="copyHeaderToClipboard()" class="text-xs bg-white border border-gray-300 px-2 py-1 rounded hover:bg-gray-100 transition-colors">
                            <i class="fas fa-copy"></i> 양식(헤더) 복사하기
                        </button>
                    </div>
                    <p>1. 엑셀이나 구글 시트에서 데이터를 복사(Ctrl+C)하세요.</p>
                    <p>2. 아래 텍스트 상자에 붙여넣기(Ctrl+V) 하세요.</p>
                    <p>3. <strong>데이터 순서:</strong> <span class="bg-white px-1 border rounded text-gray-800 font-mono">닉네임 | 길드 | 직업(선택)</span></p>
                    <p class="text-xs text-gray-400">* 빈 칸은 기본값으로 채워집니다 (직위: 스콘, 본캐: O)</p>
                </div>

                <!-- Input Area -->
                <div class="flex-1 flex flex-col lg:flex-row gap-4 min-h-0">
                    <div class="flex-1 flex flex-col">
                        <label class="font-bold text-gray-700 mb-1">데이터 붙여넣기</label>
                        <textarea id="bulkInput" oninput="parseBulkInput()" class="w-full flex-1 border border-gray-300 rounded-xl p-3 font-mono text-xs focus:ring-2 focus:ring-green-500 outline-none resize-none" placeholder="예시:\n홍길동\t뚠카롱\t비숍\n김철수\t밤카롱"></textarea>
                    </div>
                    <div class="flex-none flex items-center justify-center">
                        <button onclick="parseBulkInput()" class="lg:rotate-90 bg-green-100 text-green-700 p-3 rounded-full hover:bg-green-200 transition-colors" title="데이터 분석(자동으로 됨)">
                            <i class="fas fa-arrow-right lg:hidden"></i>
                            <i class="fas fa-arrow-down hidden lg:block"></i>
                        </button>
                    </div>
                    <div class="flex-1 flex flex-col min-h-[200px]">
                        <label class="font-bold text-gray-700 mb-1">미리보기 (상위 50개)</label>
                        <div class="border border-gray-200 rounded-xl overflow-auto bg-gray-50 flex-1">
                            <table class="w-full text-left text-xs whitespace-nowrap">
                                <thead class="bg-gray-100 text-gray-500 sticky top-0">
                                    <tr>
                                        <th class="px-3 py-2">상태</th>
                                        <th class="px-3 py-2 sortable hover:text-green-700" onclick="sortBulkPreview('name')">
                                            닉네임 <i class="fas fa-sort ml-1"></i>
                                        </th>
                                        <th class="px-3 py-2 sortable hover:text-green-700" onclick="sortBulkPreview('guild')">
                                            길드 <i class="fas fa-sort ml-1"></i>
                                        </th>
                                        <th class="px-3 py-2">직위</th>
                                        <th class="px-3 py-2">직업</th>
                                    </tr>
                                </thead>
                                <tbody id="bulkPreviewBody" class="divide-y divide-gray-100 bg-white">
                                    <tr><td colspan="5" class="px-3 py-10 text-center text-gray-400">데이터를 붙여넣으세요.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-3 shrink-0">
                <span id="bulkStats" class="text-sm text-gray-500 flex items-center mr-auto"></span>
                <button onclick="closeModal('bulkModal')" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-bold transition-colors">취소</button>
                <button onclick="saveBulkData()" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-bold transition-colors shadow-md shadow-green-200">
                    <i class="fas fa-check mr-1"></i> 일괄 등록하기
                </button>
            </div>
        </div>
    </div>

    <!-- Bulk Confirm Modal -->
    <div id="bulkConfirmModal" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm overflow-hidden">
            <div class="p-4 bg-green-50 border-b border-green-100 flex justify-between items-center">
                <h3 class="font-bold text-green-700 flex items-center gap-2">
                    <i class="fas fa-check-circle"></i> 등록 확인
                </h3>
                <button onclick="closeModal('bulkConfirmModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 text-center">
                <p class="text-gray-800 font-bold text-lg mb-2">총 <span id="bulkConfirmCount" class="text-green-600">0</span>명을 등록하시겠습니까?</p>
                <p class="text-gray-600 text-sm mb-6">기존 명단에 추가됩니다.</p>
                <div class="flex gap-3">
                    <button onclick="closeModal('bulkConfirmModal')" class="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg font-bold hover:bg-gray-200 transition-colors">취소</button>
                    <button onclick="executeBulkSave()" class="flex-1 py-2 bg-green-500 text-white rounded-lg font-bold hover:bg-green-600 transition-colors shadow-md shadow-green-200">확인</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm overflow-hidden">
            <div class="p-4 bg-red-50 border-b border-red-100 flex justify-between items-center">
                <h3 class="font-bold text-red-700 flex items-center gap-2">
                    <i class="fas fa-user-minus"></i> 멤버 제외 처리
                </h3>
                <button onclick="closeModal('deleteModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <input type="hidden" id="deleteTargetId">
                <p class="text-gray-700 mb-4 font-medium text-center">
                    <span id="deleteTargetName" class="text-lg font-bold text-gray-900"></span> 님을<br/>
                    길드 명단에서 제외하시겠습니까?
                </p>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">처리 유형</label>
                        <div class="flex gap-2">
                            <button type="button" onclick="setDeleteType('leave')" id="btnTypeLeave" class="flex-1 py-2 rounded-lg border text-sm font-medium transition-colors bg-gray-700 text-white border-gray-700">자진 탈퇴</button>
                            <button type="button" onclick="setDeleteType('kick')" id="btnTypeKick" class="flex-1 py-2 rounded-lg border text-sm font-medium transition-colors bg-white text-gray-600 border-gray-200 hover:bg-red-50">강제 추방</button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">상세 사유 (기록용)</label>
                        <input type="text" id="deleteReason" class="w-full border border-gray-200 rounded-lg p-2 focus:ring-2 focus:ring-red-200 outline-none text-sm" placeholder="예: 게임 접음, 길드 이전">
                    </div>
                    <button onclick="confirmDelete()" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 transition-colors shadow-md shadow-red-100">
                        처리 완료
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Data Confirmation Modal -->
    <div id="resetModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm overflow-hidden">
            <div class="p-4 bg-red-50 border-b border-red-100 flex justify-between items-center">
                <h3 class="font-bold text-red-700 flex items-center gap-2">
                    <i class="fas fa-exclamation-triangle"></i> 데이터 초기화
                </h3>
                <button onclick="closeModal('resetModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 text-center">
                <p class="text-gray-800 font-bold text-lg mb-2">정말로 초기화하시겠습니까?</p>
                <p class="text-gray-600 text-sm mb-6">모든 멤버 정보와 이력이 영구적으로 삭제됩니다.<br>이 작업은 되돌릴 수 없습니다.</p>
                <div class="flex gap-3">
                    <button onclick="closeModal('resetModal')" class="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg font-bold hover:bg-gray-200 transition-colors">취소</button>
                    <button onclick="confirmReset()" class="flex-1 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition-colors shadow-md shadow-red-100">초기화 실행</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Data & State ---
        const defaultRanks = ['마카롱', '다쿠아즈', '크라운', '파르페', '티라미슈', '크로칸슈', '롤케이크', '팬케이크', '와플', '스콘'];
        
        // Define default state separately
        const defaultAppState = {
            activeTab: 'dashboard',
            guilds: [
                { id: 'ddun', name: '뚠카롱', type: 'Main 1기', color: 'bg-pink-100 text-pink-700', icon: 'fa-crown', max: 200 },
                { id: 'ddung', name: '뚱카롱', type: 'Main 2기', color: 'bg-rose-100 text-rose-700', icon: 'fa-heart', max: 200 },
                { id: 'bam', name: '밤카롱', type: '부캐길드', color: 'bg-indigo-100 text-indigo-700', icon: 'fa-moon', max: 200 },
                { id: 'byeol', name: '별카롱', type: '부캐길드', color: 'bg-yellow-100 text-yellow-700', icon: 'fa-star', max: 200 },
                { id: 'dal', name: '달카롱', type: '부캐길드', color: 'bg-blue-100 text-blue-700', icon: 'fa-sun', max: 200 },
                { id: 'kkul', name: '꿀카롱', type: '부캐길드', color: 'bg-amber-100 text-amber-700', icon: 'fa-cube', max: 200 },
            ],
            guildRanks: {
                '뚠카롱': [...defaultRanks],
                '뚱카롱': [...defaultRanks],
                '밤카롱': [...defaultRanks],
                '별카롱': [...defaultRanks],
                '달카롱': [...defaultRanks],
                '꿀카롱': [...defaultRanks],
            },
            members: [
                { id: 1, name: '길마님', guild: '뚠카롱', role: '마카롱', class: '비숍', isMain: true, mainCharName: '', joinDate: '2023-01-01' },
                { id: 2, name: '부길마1', guild: '뚱카롱', role: '다쿠아즈', class: '나이트로드', isMain: true, mainCharName: '', joinDate: '2023-01-05' },
                { id: 3, name: '부길마2', guild: '뚠카롱', role: '다쿠아즈', class: '듀얼블레이더', isMain: true, mainCharName: '', joinDate: '2023-02-10' },
                { id: 4, name: '고인물1', guild: '뚠카롱', role: '크라운', class: '바이퍼', isMain: true, mainCharName: '', joinDate: '2023-03-15' },
                { id: 5, name: '새벽감성', guild: '별카롱', role: '티라미슈', class: '소울마스터', isMain: false, mainCharName: '고인물1', joinDate: '2023-06-20' },
                { id: 6, name: '배고픈다람쥐', guild: '밤카롱', role: '크로칸슈', class: '윈드브레이커', isMain: true, mainCharName: '', joinDate: '2023-07-01' },
                { id: 7, name: '달토끼', guild: '달카롱', role: '팬케이크', class: '아델', isMain: false, mainCharName: '배고픈다람쥐', joinDate: '2023-08-15' },
                { id: 8, name: '꿀단지', guild: '꿀카롱', role: '와플', class: '도화가', isMain: false, mainCharName: '길마님', joinDate: '2023-09-10' },
                { id: 9, name: '메린이', guild: '뚠카롱', role: '스콘', class: '패스파인더', isMain: true, mainCharName: '', joinDate: '2024-01-01' },
                { id: 10, name: '마카롱조아', guild: '뚠카롱', role: '파르페', class: '히어로', isMain: true, mainCharName: '', joinDate: '2023-11-11' }
            ],
            history: [
                { id: 1, type: 'leave', content: "'트롤유저'님이 탈퇴했습니다. (사유: 접음)", date: '2024-04-01', category: 'leave' },
                { id: 2, type: 'join', content: "'메린이'님이 가입했습니다.", date: '2024-01-01', category: 'join' },
                { id: 3, type: 'kick', content: "'비매너'님이 추방되었습니다. (사유: 스틸)", date: '2023-12-25', category: 'kick' }
            ],
            filters: {
                guild: 'all',
                search: '',
                sortField: null,
                sortOrder: 'asc'
            },
            deleteType: 'leave',
            tempSettingsRankGuild: '뚠카롱',
            parsedBulkData: [],
            bulkSort: { field: null, order: 'asc' }
        };

        // Initialize state (will be overwritten by localStorage if exists)
        let appState = JSON.parse(JSON.stringify(defaultAppState));

        // --- Persistence Logic ---
        function saveAppState() {
            localStorage.setItem('macaron_guild_data', JSON.stringify(appState));
        }

        function loadAppState() {
            const saved = localStorage.getItem('macaron_guild_data');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Merge saved state with default structure to ensure new fields exist
                    // But for simple array replacement, simple assign is ok. 
                    // We keep UI state (tabs) from default/reset, but load data.
                    appState.members = parsed.members || [];
                    appState.history = parsed.history || [];
                    appState.guildRanks = parsed.guildRanks || defaultAppState.guildRanks;
                    // Guilds might be customized later, so load them too if we allowed editing guilds
                    if (parsed.guilds) appState.guilds = parsed.guilds;
                } catch (e) {
                    console.error("Failed to load state", e);
                }
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadAppState(); // Load data from local storage
            initSidebar();
            initFormSelects();
            router('dashboard');
            updateTotalCount();
        });

        // --- Navigation Logic ---
        function router(page) {
            appState.activeTab = page;
            
            // Update Sidebar UI
            document.querySelectorAll('.nav-item').forEach(el => {
                if (el.dataset.target === page) {
                    el.classList.add('bg-gradient-to-r', 'from-pink-400', 'to-rose-400', 'text-white', 'shadow-md');
                    el.classList.remove('text-gray-600', 'hover:bg-pink-50');
                } else {
                    el.classList.remove('bg-gradient-to-r', 'from-pink-400', 'to-rose-400', 'text-white', 'shadow-md');
                    el.classList.add('text-gray-600', 'hover:bg-pink-50');
                }
            });

            // Set Title
            const titles = {
                'dashboard': '길드 현황판',
                'members': '길드원 조회',
                'history': '가입/탈퇴 이력',
                'settings': '길드 설정'
            };
            document.getElementById('pageTitle').innerText = titles[page];

            // Render Content
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = ''; // Clear

            if (page === 'dashboard') renderDashboard(contentArea);
            else if (page === 'members') renderMembers(contentArea);
            else if (page === 'history') renderHistory(contentArea);
            else if (page === 'settings') renderSettings(contentArea);

            // Close mobile sidebar if open
            if (window.innerWidth < 1024) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('sidebarOverlay').classList.add('hidden');
            }
        }

        // --- Rendering Functions ---

        function renderDashboard(container) {
            // Intro Paragraph
            const intro = document.createElement('div');
            intro.className = "mb-6 text-gray-600";
            intro.innerHTML = `<p>메인 길드와 부캐 길드의 인원 현황 및 주요 공지사항을 한눈에 확인할 수 있습니다. 차트를 통해 길드별 인원 분포를 파악하세요.</p>`;
            container.appendChild(intro);

            // Charts
            const chartSection = document.createElement('div');
            chartSection.className = "grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8";
            chartSection.innerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                     <h3 class="text-lg font-bold text-gray-800 mb-4">길드별 인원 분포</h3>
                     <div class="chart-container">
                        <canvas id="guildDistributionChart"></canvas>
                     </div>
                </div>
                 <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 flex flex-col justify-center">
                     <h3 class="text-lg font-bold text-gray-800 mb-4">주요 알림</h3>
                     <div class="space-y-4">
                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 flex items-start gap-3">
                            <i class="fas fa-bell text-indigo-500 mt-1"></i>
                            <div>
                                <h4 class="font-bold text-indigo-900">이번 주 공지</h4>
                                <p class="text-sm text-indigo-700">이번 주말 수로/플래그 필참입니다. 참여율 저조 시 경고 부여 예정입니다.</p>
                            </div>
                        </div>
                        <div class="bg-pink-50 p-4 rounded-xl border border-pink-100 flex items-start gap-3">
                            <i class="fas fa-user-plus text-pink-500 mt-1"></i>
                            <div>
                                <h4 class="font-bold text-pink-900">가입 대기</h4>
                                <p class="text-sm text-pink-700">현재 8명의 신규 가입 요청이 대기 중입니다. (뚠카롱 5, 별카롱 3)</p>
                            </div>
                        </div>
                     </div>
                </div>
            `;
            container.appendChild(chartSection);

            // Guild Cards
            const grid = document.createElement('div');
            grid.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6";
            
            appState.guilds.forEach(guild => {
                const memberCount = appState.members.filter(m => m.guild === guild.name).length;
                const percentage = (memberCount / guild.max) * 100;
                let barColor = percentage > 90 ? 'bg-red-400' : 'bg-green-400';
                
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-all cursor-pointer hover:border-pink-200 group";
                card.onclick = () => { appState.filters.guild = guild.name; router('members'); };
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-3 rounded-xl ${guild.color} group-hover:scale-110 transition-transform">
                            <i class="fas ${guild.icon} text-xl"></i>
                        </div>
                        <span class="text-xs px-2 py-1 rounded-full font-medium ${guild.type.includes('Main') ? 'bg-pink-100 text-pink-600' : 'bg-gray-100 text-gray-600'}">
                            ${guild.type}
                        </span>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-1">${guild.name}</h3>
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-sm text-gray-500">현재 인원</span>
                        <span class="text-sm font-bold text-gray-800">${memberCount} <span class="text-gray-400 font-normal">/ ${guild.max}</span></span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2">
                        <div class="h-2 rounded-full transition-all duration-500 ${barColor}" style="width: ${percentage}%"></div>
                    </div>
                `;
                grid.appendChild(card);
            });
            container.appendChild(grid);

            // Init Chart
            initDashboardChart();
        }

        function renderMembers(container) {
            // Toolbar
            const toolbar = document.createElement('div');
            toolbar.className = "bg-white p-6 rounded-t-2xl shadow-sm border border-gray-200 border-b-0 flex flex-col gap-4";
            
            // Filter Buttons
            let filterHtml = `<div class="flex gap-2 overflow-x-auto pb-2 md:pb-0 w-full md:w-auto no-scrollbar">`;
            const allActive = appState.filters.guild === 'all';
            filterHtml += `<button onclick="filterGuild('all')" data-guild="all" class="filter-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${allActive ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">전체보기</button>`;
            
            appState.guilds.forEach(g => {
                const active = appState.filters.guild === g.name;
                const activeClass = 'bg-pink-500 text-white';
                const inactiveClass = 'bg-gray-100 text-gray-600 hover:bg-gray-200';
                filterHtml += `<button onclick="filterGuild('${g.name}')" data-guild="${g.name}" class="filter-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${active ? activeClass : inactiveClass}">${g.name}</button>`;
            });
            filterHtml += `</div>`;

            // Actions & Search
            toolbar.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    ${filterHtml}
                    <div class="flex gap-2 w-full md:w-auto">
                        <button onclick="openBulkModal()" class="flex items-center justify-center gap-2 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm font-bold flex-1 md:flex-none">
                            <i class="fas fa-file-excel"></i> 엑셀/시트 붙여넣기
                        </button>
                        <button onclick="openAddModal()" class="flex items-center justify-center gap-2 px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-colors text-sm font-bold flex-1 md:flex-none">
                            <i class="fas fa-plus"></i> 멤버 등록
                        </button>
                    </div>
                </div>
                <div class="relative w-full">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" oninput="filterSearch(this.value)" placeholder="닉네임, 본캐닉 검색..." class="w-full pl-10 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500" value="${appState.filters.search}">
                </div>
            `;
            container.appendChild(toolbar);

            // Table Container
            const tableContainer = document.createElement('div');
            tableContainer.id = 'memberTableContainer';
            tableContainer.className = "bg-white rounded-b-2xl shadow-sm border border-gray-200 overflow-x-auto";
            container.appendChild(tableContainer);

            // Initial Table Render
            updateMemberTable();
        }

        function sortMembers(field) {
            if (appState.filters.sortField === field) {
                appState.filters.sortOrder = appState.filters.sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                appState.filters.sortField = field;
                appState.filters.sortOrder = 'asc';
            }
            updateMemberTable();
        }

        function updateMemberTable() {
            const container = document.getElementById('memberTableContainer');
            if (!container) return;

            let filtered = appState.members.filter(m => {
                const matchGuild = appState.filters.guild === 'all' || m.guild === appState.filters.guild;
                const searchLower = appState.filters.search.toLowerCase();
                const matchSearch = m.name.toLowerCase().includes(searchLower) || (m.mainCharName && m.mainCharName.toLowerCase().includes(searchLower));
                return matchGuild && matchSearch;
            });

            // Sorting logic
            if (appState.filters.sortField) {
                filtered.sort((a, b) => {
                    const field = appState.filters.sortField;
                    const order = appState.filters.sortOrder === 'asc' ? 1 : -1;
                    if (a[field] < b[field]) return -1 * order;
                    if (a[field] > b[field]) return 1 * order;
                    return 0;
                });
            }

            const getSortIcon = (field) => {
                if (appState.filters.sortField !== field) return '<i class="fas fa-sort ml-1 text-gray-300"></i>';
                return appState.filters.sortOrder === 'asc' ? '<i class="fas fa-sort-up ml-1 text-pink-500"></i>' : '<i class="fas fa-sort-down ml-1 text-pink-500"></i>';
            };

            let tableHtml = `
                <table class="w-full text-left min-w-[800px]">
                    <thead class="bg-gray-50 text-gray-500 text-sm">
                        <tr>
                            <th class="px-6 py-4 font-medium sortable" onclick="sortMembers('name')">닉네임 ${getSortIcon('name')}</th>
                            <th class="px-6 py-4 font-medium">구분</th>
                            <th class="px-6 py-4 font-medium sortable" onclick="sortMembers('guild')">소속 길드 ${getSortIcon('guild')}</th>
                            <th class="px-6 py-4 font-medium">직위</th>
                            <th class="px-6 py-4 font-medium">직업</th>
                            <th class="px-6 py-4 font-medium">가입일</th>
                            <th class="px-6 py-4 font-medium text-right">관리</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
            `;

            if (filtered.length === 0) {
                tableHtml += `<tr><td colspan="7" class="px-6 py-12 text-center text-gray-400">검색 결과가 없습니다.</td></tr>`;
            } else {
                filtered.forEach(m => {
                    const isMainBadge = m.isMain 
                        ? `<span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-bold bg-pink-500 text-white shadow-sm"><i class="fas fa-crown mr-1"></i> 본캐</span>`
                        : `<div class="flex flex-col items-start"><span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-gray-200 text-gray-600 mb-1">부캐</span><span class="text-xs text-gray-500 font-medium"><i class="fas fa-user mr-1"></i> 본캐: <span class="text-pink-600">${m.mainCharName}</span></span></div>`;
                    
                    const guildObj = appState.guilds.find(g => g.name === m.guild) || {};
                    const guildBadge = `<span class="px-2 py-1 rounded text-xs font-medium ${guildObj.type && guildObj.type.includes('Main') ? 'bg-pink-100 text-pink-700' : 'bg-indigo-100 text-indigo-700'}">${m.guild}</span>`;

                    tableHtml += `
                        <tr class="hover:bg-pink-50/30 transition-colors group">
                            <td class="px-6 py-4 font-bold text-gray-800">${m.name}</td>
                            <td class="px-6 py-4">${isMainBadge}</td>
                            <td class="px-6 py-4">${guildBadge}</td>
                            <td class="px-6 py-4"><span class="px-2 py-1 rounded-md text-xs font-bold bg-gray-100 text-gray-700">${m.role}</span></td>
                            <td class="px-6 py-4">
                                <span class="text-sm text-gray-600">${m.class || '-'}</span>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-500 font-mono">${m.joinDate}</td>
                            <td class="px-6 py-4 text-right">
                                <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="openEditModal(${m.id})" class="p-2 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition-colors" title="수정"><i class="fas fa-cog"></i></button>
                                    <button onclick="openDeleteModal(${m.id})" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="삭제"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            
            tableHtml += `</tbody></table>`;
            container.innerHTML = tableHtml;
        }

        function filterGuild(guild) {
            appState.filters.guild = guild;
            // Update Buttons State
            document.querySelectorAll('.filter-btn').forEach(btn => {
                const target = btn.dataset.guild;
                if (target === guild) {
                    if (target === 'all') {
                        btn.className = "filter-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors bg-gray-800 text-white";
                    } else {
                        btn.className = "filter-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors bg-pink-500 text-white";
                    }
                } else {
                    btn.className = "filter-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors bg-gray-100 text-gray-600 hover:bg-gray-200";
                }
            });
            updateMemberTable();
        }

        function filterSearch(val) {
            appState.filters.search = val;
            updateMemberTable();
        }

        function renderHistory(container) {
            // Intro
             const intro = document.createElement('div');
            intro.className = "mb-6 text-gray-600";
            intro.innerHTML = `<p>길드원의 가입, 탈퇴, 추방 등 모든 운영 기록이 저장되는 공간입니다.</p>`;
            container.appendChild(intro);

            const tableCard = document.createElement('div');
            tableCard.className = "bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden";
            
            let html = `
                <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2"><i class="fas fa-clipboard-list text-pink-500"></i> 운영 로그</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 text-gray-500 text-sm border-b border-gray-100">
                            <tr>
                                <th class="px-6 py-4 font-medium w-32">유형</th>
                                <th class="px-6 py-4 font-medium w-40">날짜</th>
                                <th class="px-6 py-4 font-medium">내용</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
            `;

            appState.history.forEach(log => {
                let badgeClass = 'bg-gray-100 text-gray-700';
                let icon = 'fa-info-circle';
                let label = '기타';

                if (log.category === 'join') { badgeClass = 'bg-green-100 text-green-700'; icon = 'fa-user-plus'; label = '가입'; }
                else if (log.category === 'kick') { badgeClass = 'bg-red-100 text-red-700'; icon = 'fa-ban'; label = '추방'; }
                else if (log.category === 'leave') { badgeClass = 'bg-gray-200 text-gray-700'; icon = 'fa-sign-out-alt'; label = '탈퇴'; }

                html += `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg text-xs font-bold ${badgeClass}">
                                <i class="fas ${icon}"></i> ${label}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm font-mono text-gray-500">${log.date}</td>
                        <td class="px-6 py-4 text-sm text-gray-800 font-medium">${log.content}</td>
                    </tr>
                `;
            });

            if (appState.history.length === 0) {
                html += `<tr><td colspan="3" class="px-6 py-12 text-center text-gray-400">기록이 없습니다.</td></tr>`;
            }

            html += `</tbody></table></div>`;
            tableCard.innerHTML = html;
            container.appendChild(tableCard);
        }

        function renderSettings(container) {
            container.innerHTML = '';
            
            // Container for split view
            const layout = document.createElement('div');
            layout.className = "grid grid-cols-1 gap-8";
            container.appendChild(layout);

            // 1. Data Reset Section
            const resetCard = document.createElement('div');
            resetCard.className = "bg-white p-6 rounded-2xl shadow-sm border border-gray-200";
            resetCard.innerHTML = `
                <h3 class="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2"><i class="fas fa-database text-red-500"></i> 데이터 관리</h3>
                <p class="text-sm text-gray-600 mb-4">현재 등록된 모든 길드원 정보와 활동 기록을 삭제하고 초기화합니다. 이 작업은 되돌릴 수 없습니다.</p>
                <button onclick="openResetModal()" class="px-4 py-2 bg-red-100 text-red-600 hover:bg-red-200 rounded-lg font-bold text-sm transition-colors border border-red-200">
                    <i class="fas fa-trash-alt mr-1"></i> 모든 데이터 초기화
                </button>
            `;
            layout.appendChild(resetCard);

            // 2. Guild Rank Settings Section
            const rankCard = document.createElement('div');
            rankCard.className = "bg-white p-6 rounded-2xl shadow-sm border border-gray-200";
            
            let rankHtml = `
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2"><i class="fas fa-layer-group text-blue-500"></i> 길드별 직위 설정</h3>
                        <p class="text-sm text-gray-600 mt-1">각 길드에서 사용하는 직위 체계를 설정합니다. 설정된 직위는 멤버 등록 시 표시됩니다.</p>
                    </div>
                    <select onchange="changeSettingsRankGuild(this.value)" class="border border-gray-200 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none text-sm font-bold text-gray-700 bg-gray-50">
            `;
            appState.guilds.forEach(g => {
                const selected = g.name === appState.tempSettingsRankGuild ? 'selected' : '';
                rankHtml += `<option value="${g.name}" ${selected}>${g.name}</option>`;
            });
            rankHtml += `</select></div>`;

            // Ranks List
            const currentRanks = appState.guildRanks[appState.tempSettingsRankGuild] || [];
            rankHtml += `<div class="space-y-2 mb-4">`;
            currentRanks.forEach((r, idx) => {
                rankHtml += `
                    <div class="flex items-center gap-2">
                        <span class="w-8 text-center text-xs font-bold text-gray-400">${idx + 1}</span>
                        <input type="text" value="${r}" onchange="updateRankValue(${idx}, this.value)" class="flex-1 border border-gray-200 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="직위 이름">
                        <button onclick="removeRank(${idx})" class="p-2 text-gray-400 hover:text-red-500"><i class="fas fa-minus-circle"></i></button>
                    </div>
                `;
            });
            rankHtml += `</div>`;

            // Add Button
            rankHtml += `
                <button onclick="addRank()" class="w-full py-2 border-2 border-dashed border-gray-200 rounded-lg text-gray-500 hover:border-blue-300 hover:text-blue-500 transition-colors text-sm font-bold mb-4">
                    <i class="fas fa-plus mr-1"></i> 직위 추가
                </button>
            `;

            // Save Info
            rankHtml += `<div class="bg-blue-50 text-blue-700 text-xs p-3 rounded-lg"><i class="fas fa-info-circle mr-1"></i> 변경 사항은 즉시 반영되며, 멤버 등록/수정 창의 '직위' 목록에 나타납니다.</div>`;

            rankCard.innerHTML = rankHtml;
            layout.appendChild(rankCard);
        }

        // --- Logic & Helpers ---

        function initSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            document.getElementById('openSidebar').addEventListener('click', () => {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            });
            
            const close = () => {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            };

            document.getElementById('closeSidebar').addEventListener('click', close);
            overlay.addEventListener('click', close);
        }

        function initFormSelects() {
            const guildSelect = document.getElementById('inputGuild');
            guildSelect.innerHTML = ''; // clear
            appState.guilds.forEach((g, idx) => {
                const opt = document.createElement('option');
                opt.value = g.name;
                opt.text = g.name;
                guildSelect.appendChild(opt);
            });
            
            // Initial role population based on first guild
            if(appState.guilds.length > 0) {
                updateRoleSelect(appState.guilds[0].name);
            }

            // Form Submit
            document.getElementById('memberForm').addEventListener('submit', (e) => {
                e.preventDefault();
                saveMember();
            });
        }

        function onGuildSelectChange(guildName) {
            updateRoleSelect(guildName);
        }

        function updateRoleSelect(guildName) {
            const roleSelect = document.getElementById('inputRole');
            roleSelect.innerHTML = ''; // Clear existing
            
            const ranks = appState.guildRanks[guildName] || defaultRanks;
            
            ranks.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r;
                opt.text = r;
                roleSelect.appendChild(opt);
            });
        }

        function initDashboardChart() {
            const ctx = document.getElementById('guildDistributionChart').getContext('2d');
            const data = appState.guilds.map(g => {
                return appState.members.filter(m => m.guild === g.name).length;
            });
            const labels = appState.guilds.map(g => g.name);
            const colors = ['#f472b6', '#fb7185', '#818cf8', '#facc15', '#60a5fa', '#fbbf24'];

            new Chart(ctx, {
                type: 'bar', // Using Bar for clearer comparison than Doughnut
                data: {
                    labels: labels,
                    datasets: [{
                        label: '길드원 수',
                        data: data,
                        backgroundColor: colors,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function updateTotalCount() {
            let displayCount = appState.members.length;
            // Check if we are still using initial data structure roughly
            if (appState.members.length > 0 && appState.members[0].name === '길마님') {
                 displayCount += 120; // Mock offset
            }
            document.getElementById('totalMembersCount').innerText = displayCount;
        }

        // --- Settings Logic ---
        function openResetModal() {
            document.getElementById('resetModal').classList.remove('hidden');
        }

        function confirmReset() {
            appState.members = [];
            appState.history = [];
            saveAppState(); // Save empty state
            closeModal('resetModal');
            updateTotalCount();
            alert("모든 데이터가 초기화되었습니다.");
        }

        function changeSettingsRankGuild(guildName) {
            appState.tempSettingsRankGuild = guildName;
            renderSettings(document.getElementById('contentArea'));
        }

        function updateRankValue(index, newValue) {
            const guild = appState.tempSettingsRankGuild;
            if (appState.guildRanks[guild]) {
                appState.guildRanks[guild][index] = newValue;
                saveAppState(); // Save changes
            }
        }

        function removeRank(index) {
            const guild = appState.tempSettingsRankGuild;
            if (appState.guildRanks[guild]) {
                appState.guildRanks[guild].splice(index, 1);
                saveAppState(); // Save changes
                renderSettings(document.getElementById('contentArea'));
            }
        }

        function addRank() {
            const guild = appState.tempSettingsRankGuild;
            if (appState.guildRanks[guild]) {
                appState.guildRanks[guild].push("새 직위");
                saveAppState(); // Save changes
                renderSettings(document.getElementById('contentArea'));
            }
        }

        // --- Bulk Upload Logic ---
        function openBulkModal() {
            document.getElementById('bulkModal').classList.remove('hidden');
            document.getElementById('bulkInput').value = '';
            document.getElementById('bulkPreviewBody').innerHTML = '<tr><td colspan="5" class="px-3 py-10 text-center text-gray-400">데이터를 붙여넣으세요.</td></tr>';
            appState.parsedBulkData = [];
            updateBulkStats(0, 0);
        }

        function copyHeaderToClipboard() {
            const header = "닉네임\t길드\t직업";
            const textarea = document.createElement("textarea");
            textarea.value = header;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                alert("양식(헤더)이 복사되었습니다. 엑셀에 붙여넣고 사용하세요.");
            } catch (err) {
                alert("복사에 실패했습니다.");
            }
            document.body.removeChild(textarea);
        }

        function parseBulkInput() {
            const raw = document.getElementById('bulkInput').value.trim();
            if (!raw) {
                appState.parsedBulkData = [];
                renderBulkPreview();
                return;
            }

            const lines = raw.split('\n');
            const parsed = [];
            const today = new Date().toISOString().split('T')[0];

            lines.forEach(line => {
                let cols = line.split('\t').map(c => c.trim());
                if (cols.length === 1 && line.includes(',')) {
                    cols = line.split(',').map(c => c.trim());
                }

                if (cols.length === 0 || (cols.length === 1 && cols[0] === '')) return;

                // Expected: Name | Guild | Job
                const name = cols[0];
                if (!name) return;

                const guildNameInput = cols[1];
                let guild = appState.guilds[0].name; 
                let isValidGuild = true;

                if (guildNameInput) {
                    const matchedGuild = appState.guilds.find(g => g.name === guildNameInput);
                    if (matchedGuild) {
                        guild = matchedGuild.name;
                    } else {
                        // For flexibility, allow import but user might want to check
                        // Default to first guild for data integrity
                        guild = appState.guilds[0].name; 
                    }
                }

                const cls = cols[2] || '-';
                const role = defaultRanks[defaultRanks.length - 1]; // Default Scone
                const isMain = true;
                const mainCharName = '';
                const joinDate = today;

                parsed.push({
                    name,
                    guild,
                    isValidGuild,
                    role,
                    class: cls,
                    isMain,
                    mainCharName,
                    joinDate
                });
            });

            appState.parsedBulkData = parsed;
            renderBulkPreview();
        }

        function sortBulkPreview(field) {
            if (appState.bulkSort.field === field) {
                appState.bulkSort.order = appState.bulkSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                appState.bulkSort.field = field;
                appState.bulkSort.order = 'asc';
            }
            renderBulkPreview();
        }

        function renderBulkPreview() {
            const tbody = document.getElementById('bulkPreviewBody');
            tbody.innerHTML = '';

            if (appState.parsedBulkData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-3 py-10 text-center text-gray-400">데이터를 붙여넣으세요.</td></tr>';
                updateBulkStats(0, 0);
                return;
            }

            // Sort logic
            let dataToShow = [...appState.parsedBulkData];
            if (appState.bulkSort.field) {
                dataToShow.sort((a, b) => {
                    const field = appState.bulkSort.field;
                    const order = appState.bulkSort.order === 'asc' ? 1 : -1;
                    if (a[field] < b[field]) return -1 * order;
                    if (a[field] > b[field]) return 1 * order;
                    return 0;
                });
            }

            dataToShow.slice(0, 50).forEach(d => {
                const tr = document.createElement('tr');
                const statusColor = 'text-green-600';
                const statusIcon = '<i class="fas fa-check"></i>';
                
                tr.innerHTML = `
                    <td class="px-3 py-2 ${statusColor}">${statusIcon}</td>
                    <td class="px-3 py-2 font-medium">${d.name}</td>
                    <td class="px-3 py-2">${d.guild}</td>
                    <td class="px-3 py-2">${d.role}</td>
                    <td class="px-3 py-2">${d.class}</td>
                `;
                tbody.appendChild(tr);
            });

            if (appState.parsedBulkData.length > 50) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="3" class="px-3 py-2 text-center text-gray-500 italic">...외 ${appState.parsedBulkData.length - 50}명 더 있음</td>`;
                tbody.appendChild(tr);
            }

            updateBulkStats(appState.parsedBulkData.length, 0);
        }

        function updateBulkStats(total, errors) {
            const statsEl = document.getElementById('bulkStats');
            if (total === 0) {
                statsEl.innerText = '';
                return;
            }
            statsEl.innerHTML = `<span class="text-green-600 font-bold"><i class="fas fa-check-circle"></i> ${total}명 인식됨</span>`;
        }

        function saveBulkData() {
            if (appState.parsedBulkData.length === 0) {
                parseBulkInput();
            }

            if (appState.parsedBulkData.length === 0) {
                const input = document.getElementById('bulkInput');
                input.classList.add('ring-2', 'ring-red-500', 'border-red-500');
                input.placeholder = "데이터가 없습니다. 여기에 붙여넣어주세요!";
                setTimeout(() => {
                    input.classList.remove('ring-2', 'ring-red-500', 'border-red-500');
                }, 2000);
                return;
            }

            document.getElementById('bulkConfirmCount').innerText = appState.parsedBulkData.length;
            document.getElementById('bulkConfirmModal').classList.remove('hidden');
        }

        function executeBulkSave() {
            let addedCount = 0;
            let baseId = Date.now();

            appState.parsedBulkData.forEach((d, index) => {
                appState.members.push({
                    id: baseId + index, 
                    name: d.name,
                    guild: d.guild,
                    role: d.role,
                    // level removed
                    class: d.class,
                    isMain: d.isMain,
                    mainCharName: d.mainCharName,
                    joinDate: d.joinDate
                });
                addedCount++;
            });

            appState.history.unshift({
                id: Date.now(),
                category: 'join',
                type: 'join',
                date: new Date().toISOString().split('T')[0],
                content: `[일괄등록] ${addedCount}명의 멤버가 추가되었습니다.`
            });

            saveAppState(); // Save changes

            closeModal('bulkConfirmModal');
            closeModal('bulkModal');
            
            document.getElementById('bulkInput').value = '';
            appState.parsedBulkData = [];
            
            router('members');
            updateTotalCount();
        }

        // --- Modal Actions ---

        function openAddModal() {
            document.getElementById('memberForm').reset();
            document.getElementById('editMemberId').value = '';
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-user-plus"></i> 멤버 등록';
            document.getElementById('inputJoinDate').value = new Date().toISOString().split('T')[0];
            
            const firstGuild = appState.guilds[0].name;
            document.getElementById('inputGuild').value = firstGuild;
            updateRoleSelect(firstGuild);

            toggleMainCharInput();
            document.getElementById('memberModal').classList.remove('hidden');
        }

        function openEditModal(id) {
            const member = appState.members.find(m => m.id === id);
            if (!member) return;

            document.getElementById('editMemberId').value = member.id;
            document.getElementById('inputName').value = member.name;
            document.getElementById('inputGuild').value = member.guild;
            
            updateRoleSelect(member.guild);
            
            document.getElementById('inputRole').value = member.role;
            // Level input removed
            document.getElementById('inputClass').value = member.class;
            document.getElementById('inputIsMain').checked = member.isMain;
            document.getElementById('inputMainCharName').value = member.mainCharName || '';
            document.getElementById('inputJoinDate').value = member.joinDate;
            
            toggleMainCharInput();
            
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-cog"></i> 멤버 수정';
            document.getElementById('memberModal').classList.remove('hidden');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function toggleMainCharInput() {
            const isMain = document.getElementById('inputIsMain').checked;
            const group = document.getElementById('mainCharInputGroup');
            if (isMain) group.classList.add('hidden');
            else group.classList.remove('hidden');
        }

        function saveMember() {
            const idStr = document.getElementById('editMemberId').value;
            const name = document.getElementById('inputName').value;
            const guild = document.getElementById('inputGuild').value;
            const role = document.getElementById('inputRole').value;
            // Level logic removed
            const cls = document.getElementById('inputClass').value;
            const isMain = document.getElementById('inputIsMain').checked;
            const mainCharName = document.getElementById('inputMainCharName').value;
            const joinDate = document.getElementById('inputJoinDate').value;

            const newMember = {
                id: idStr ? parseInt(idStr) : Date.now(),
                name, guild, role, class: cls, isMain, mainCharName, joinDate
            };

            if (idStr) {
                // Edit
                const idx = appState.members.findIndex(m => m.id === parseInt(idStr));
                if (idx !== -1) appState.members[idx] = newMember;
            } else {
                // Add
                appState.members.push(newMember);
                // Log History
                appState.history.unshift({
                    id: Date.now(),
                    category: 'join',
                    type: 'join',
                    date: new Date().toISOString().split('T')[0],
                    content: `'${name}'님이 ${guild}에 가입했습니다.`
                });
            }

            saveAppState(); // Save changes

            closeModal('memberModal');
            router('members'); // Refresh
            updateTotalCount();
        }

        function openDeleteModal(id) {
            const member = appState.members.find(m => m.id === id);
            if (!member) return;
            
            appState.memberToDelete = member;
            document.getElementById('deleteTargetName').innerText = member.name;
            document.getElementById('deleteReason').value = '';
            setDeleteType('leave');
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function setDeleteType(type) {
            appState.deleteType = type;
            const btnLeave = document.getElementById('btnTypeLeave');
            const btnKick = document.getElementById('btnTypeKick');
            
            if (type === 'leave') {
                btnLeave.className = "flex-1 py-2 rounded-lg border text-sm font-medium transition-colors bg-gray-700 text-white border-gray-700";
                btnKick.className = "flex-1 py-2 rounded-lg border text-sm font-medium transition-colors bg-white text-gray-600 border-gray-200 hover:bg-red-50";
            } else {
                btnLeave.className = "flex-1 py-2 rounded-lg border text-sm font-medium transition-colors bg-white text-gray-600 border-gray-200 hover:bg-gray-50";
                btnKick.className = "flex-1 py-2 rounded-lg border text-sm font-medium transition-colors bg-red-600 text-white border-red-600";
            }
        }

        function confirmDelete() {
            if (!appState.memberToDelete) return;
            
            const reason = document.getElementById('deleteReason').value;
            const actionText = appState.deleteType === 'kick' ? '추방되었습니다' : '탈퇴했습니다';
            const reasonText = reason ? `(사유: ${reason})` : '(사유 미입력)';

            appState.members = appState.members.filter(m => m.id !== appState.memberToDelete.id);

            appState.history.unshift({
                id: Date.now(),
                category: appState.deleteType,
                type: appState.deleteType,
                date: new Date().toISOString().split('T')[0],
                content: `'${appState.memberToDelete.name}'님이 ${actionText}. ${reasonText}`
            });

            saveAppState(); // Save changes

            closeModal('deleteModal');
            appState.memberToDelete = null;
            router('members');
            updateTotalCount();
        }

    </script>
</body>
</html>