<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëš ì¹´ë¡± ê¸¸ë“œ í˜„í™©íŒ (Public)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .chart-container { position: relative; width: 100%; height: 300px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #fbcfe8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #f472b6; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        th.sortable { cursor: pointer; user-select: none; transition: background 0.2s; position: relative; }
        th.sortable:hover { background-color: #fdf2f8 !important; color: #db2777 !important; }
        .force-hide { display: none !important; }
        #loadingOverlay { position: fixed; inset: 0; background: white; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .nav-item.active { background-color: #fdf2f8; color: #ec4899; box-shadow: inset 4px 0 0 #ec4899; }
        #msgBox { transition: all 0.3s ease; transform: translateY(100px); opacity: 0; pointer-events: none; }
        #msgBox.show { transform: translateY(0); opacity: 1; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; text-align: center; font-size: 0.75rem; }
        .calendar-day { padding: 0.25rem; border-radius: 0.75rem; position: relative; transition: all 0.2s; min-height: 56px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; aspect-ratio: 1/1; cursor: pointer; border: 1px solid transparent; }
        .calendar-day:hover { background-color: #f9fafb; border-color: #fbcfe8; }
        .calendar-day.today { background-color: #ec4899; color: white; font-weight: bold; }
        .calendar-day.thursday { color: #db2777; background-color: #fdf2f8; border: 1px solid #fbcfe8; font-weight: bold; }
        .calendar-day.not-current { opacity: 0.2; pointer-events: none; }
        .calendar-head { font-size: 0.7rem; font-weight: 800; color: #9ca3af; text-transform: uppercase; padding-bottom: 8px; }
        .event-dot { width: 4px; height: 4px; background-color: #ec4899; border-radius: 50%; margin-top: 2px; }
        .calendar-day.today .event-dot { background-color: white; }
        
        .event-snippet { 
            font-size: 11px; 
            color: #db2777; 
            opacity: 1; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            width: 100%; 
            margin-top: 3px; 
            line-height: 1.1; 
            font-weight: 800; 
            background-color: rgba(251, 207, 232, 0.3); 
            border-radius: 4px;
            padding: 1px 2px;
        }
        .calendar-day.today .event-snippet { color: white; background-color: rgba(255, 255, 255, 0.2); }

        .score-zero { background-color: #fee2e2 !important; color: #ef4444 !important; }
        .score-cell { transition: background 0.2s; }
        .score-cell:hover { background-color: #f8fafb; }
        
        .masked-text { color: #d1d5db; letter-spacing: 2px; font-size: 10px; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 h-screen overflow-hidden flex font-medium">

    <div id="loadingOverlay">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-pink-500 border-opacity-20 border-t-pink-500 mb-8 mx-auto"></div>
            <p class="text-pink-600 font-bold text-xl tracking-tight">ë°ì´í„° ë™ê¸°í™” ì¤‘...</p>
        </div>
    </div>

    <div id="msgBox" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[200] bg-slate-900 text-white px-8 py-4 rounded-2xl shadow-2xl flex items-center gap-4 border border-white/10">
        <div id="msgIcon" class="text-pink-500"><i class="fas fa-info-circle"></i></div>
        <p id="msgText" class="text-sm font-bold"></p>
    </div>

    <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 z-50 w-64 bg-white border-r border-gray-100 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col shadow-sm">
        <div class="p-6 border-b border-gray-100 flex items-center gap-3">
            <div class="w-10 h-10 rounded-2xl bg-gradient-to-tr from-pink-400 to-rose-400 flex items-center justify-center text-white font-bold shadow-lg shadow-pink-100 text-xl">ëš </div>
            <div><h1 class="text-lg font-bold text-gray-800 tracking-tight">ëš ì¹´ë¡± í˜„í™©íŒ</h1><p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest leading-none mt-1">Public View</p></div>
            <button id="closeSidebar" class="lg:hidden ml-auto text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        <nav class="p-4 space-y-2 flex-1 overflow-y-auto no-scrollbar">
            <button onclick="router('dashboard')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="dashboard"><i class="fas fa-columns w-5 text-center"></i><span>ëŒ€ì‹œë³´ë“œ</span></button>
            <button onclick="router('members')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="members"><i class="fas fa-users w-5 text-center"></i><span>ê¸¸ë“œì› ëª…ë‹¨</span></button>
            <button onclick="router('analysis')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="analysis"><i class="fas fa-chart-line w-5 text-center"></i><span>ìˆ˜ë¡œ ì ìˆ˜ ë¶„ì„</span></button>
            <button onclick="router('bail')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="bail"><i class="fas fa-gem w-5 text-center"></i><span>ë³´ì„ê¸ˆ í˜„í™©</span></button>
            <button onclick="router('penalty')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="penalty"><i class="fas fa-exclamation-triangle w-5 text-center"></i><span>ë²Œì  í˜„í™©</span></button>
        </nav>
        <div class="p-4 border-t border-gray-100 bg-gray-50/50 text-center font-bold"><p class="text-[10px] text-green-500 uppercase tracking-widest"><i class="fas fa-cloud mr-1 animate-pulse"></i> System Active</p></div>
    </aside>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black/10 z-40 hidden lg:hidden"></div>

    <main class="flex-1 flex flex-col overflow-hidden bg-gray-50">
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 shrink-0 z-10 shadow-sm">
            <div class="flex items-center gap-4"><button id="openSidebar" class="p-2 lg:hidden rounded-lg hover:bg-gray-100 text-gray-600"><i class="fas fa-bars text-xl"></i></button><h2 id="pageTitle" class="text-xl font-bold text-gray-800 tracking-tight">ëŒ€ì‹œë³´ë“œ</h2></div>
            <div class="flex items-center gap-4">
                <div class="px-4 py-1.5 bg-pink-50 text-pink-600 rounded-full text-[11px] font-bold border border-pink-100 shadow-sm">
                    âœ¨ <span id="anniversaryLabel">ë¡œë”© ì¤‘...</span>
                </div>
                <div class="hidden md:flex px-4 py-1.5 bg-slate-50 text-slate-600 rounded-full text-[11px] font-bold border border-slate-100 shadow-sm gap-2">
                    <span>ğŸ‘¥</span> <span id="totalMembersCount">ë¡œë”© ì¤‘...</span>
                </div>
                <button id="refreshBtn" onclick="fetchMembers()" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-gray-100 text-gray-400 transition-all border border-gray-100 shadow-sm"><i class="fas fa-sync-alt"></i></button>
            </div>
        </header>
        <!-- Modified Content Area Padding for wider view -->
        <div id="contentArea" class="flex-1 overflow-y-auto p-3 lg:p-6 relative bg-gray-50 flex flex-col min-h-0"></div>
    </main>

    <!-- Event Detail Modal (Read Only) -->
    <div id="eventDetailModal" class="fixed inset-0 z-[120] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in font-bold">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-sm p-10 border border-gray-50 relative">
            <div class="flex justify-between items-center mb-10">
                <h3 id="eventDetailDate" class="text-2xl font-black text-slate-800 tracking-tighter">2026-02-18</h3>
                <button onclick="closeModal('eventDetailModal')" class="text-gray-400 hover:text-gray-600 text-xl"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="space-y-8">
                <div class="space-y-2">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ì¼ì • ì œëª©</label>
                    <div id="eventTitleDisplay" class="w-full bg-gray-50 rounded-2xl p-5 text-sm font-bold shadow-inner text-gray-700"></div>
                </div>
                
                <div class="space-y-2">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ìƒì„¸ ë‚´ìš©</label>
                    <div id="eventContentDisplay" class="w-full bg-gray-50 rounded-2xl p-5 text-sm font-bold shadow-inner text-gray-700 min-h-[100px] whitespace-pre-wrap"></div>
                </div>
            </div>

            <div class="mt-8 text-center">
                <button onclick="closeModal('eventDetailModal')" class="px-8 py-3 bg-gray-100 text-gray-500 rounded-xl font-bold text-xs hover:bg-gray-200 transition-all">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyOylLKXCCvWuHOliqYRP6sK_sOIRe9AmnfGg5xwNNMKD8eDf2K-J4oM7FpEbWVypkrrA/exec";
        const GUILD_START_DATE = new Date('2020-03-17');
        const MAPLE_JOBS = ["íˆì–´ë¡œ", "ë‹¤í¬ë‚˜ì´íŠ¸", "íŒ”ë¼ë”˜", "ë¶ˆë…", "ì¬ì½œ", "ë¹„ìˆ", "ë³´ìš°ë§ˆìŠ¤í„°", "ì‹ ê¶", "íŒ¨ìŠ¤íŒŒì¸ë”","ë‚˜ì´íŠ¸ë¡œë“œ", "ì„€ë„ì–´", "ë“€ì–¼ë¸”ë ˆì´ë“œ", "ìº¡í‹´", "ë°”ì´í¼", "ìºë…¼ë§ˆìŠ¤í„°","ë¯¸í•˜ì¼", "ì†Œìš¸ë§ˆìŠ¤í„°", "í”Œë ˆì„ìœ„ìë“œ", "ìœˆë“œë¸Œë ˆì´ì»¤", "ë‚˜ì´íŠ¸ì›Œì»¤", "ìŠ¤íŠ¸ë¼ì´ì»¤","ì•„ë€", "ì—ë°˜", "ë£¨ë¯¸ë„ˆìŠ¤", "ë©”ë¥´ì„¸ë°ìŠ¤", "íŒ¬í…€", "ì€ì›”","ë°ëª¬ ìŠ¬ë ˆì´ì–´", "ë°ëª¬ ì–´ë²¤ì ¸", "ë¸”ë˜ìŠ¤í„°", "ë°°í‹€ë©”ì´ì§€", "ì™€ì¼ë“œí—Œí„°", "ë©”ì¹´ë‹‰", "ì œë…¼","ì¹´ì´ì €", "ì¹´ì¸", "ì¹´ë°ë‚˜", "ì—”ì ¤ë¦­ë²„ìŠ¤í„°","ë¼ë¼", "í˜¸ì˜", "ì•„ë¸", "ì¼ë¦¬ì›€", "ì•„í¬", "ì¹¼ë¦¬","ì œë¡œ", "í‚¤ë„¤ì‹œìŠ¤", "ë Œ"];
        const baseRanks = ['ë§ˆì¹´ë¡±', 'ë‹¤ì¿ ì•„ì¦ˆ'];
        const initialGuildRanks = {
            'ëš ì¹´ë¡±': [...baseRanks, 'í¬ë¼ìš´', 'íŒŒë¥´í˜', 'í‹°ë¼ë¯¸ìŠˆ', 'í¬ë¡œì¹¸ìŠˆ', 'ë¡¤ì¼€ì´í¬', 'íŒ¬ì¼€ì´í¬', 'ì™€í”Œ'],
            'ëš±ì¹´ë¡±': [...baseRanks, 'ëš ì¼€ì´í¬', 'ëš ë¸Œë ˆë“œ', 'ìˆ˜í”Œë ˆ', 'ëš ìŠ¤ì½˜', 'ë°˜ì£½', 'ë°˜ì£½(íœ´ë©´)', 'ì•„ì¸ìŠˆí˜ë„ˆ'],
            'ë°¤ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆí˜ë„ˆ', 'ë°˜ì£½', 'ë°˜ì£½(íœ´ë©´)'],
            'ë³„ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆí˜ë„ˆ', 'ë°˜ì£½', 'ë°˜ì£½(íœ´ë©´)'],
            'ë‹¬ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆí˜ë„ˆ', 'ë°˜ì£½', 'ë°˜ì£½(íœ´ë©´)'],
            'ê¿€ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆí˜ë„ˆ', 'ë°˜ì£½', 'ë°˜ì£½(íœ´ë©´)']
        };
        const ITEMS_PER_PAGE = 17;

        // --- GLOBAL STATE ---
        let jobChartInstance = null;
        let analysisChartInstance = null;

        const appState = {
            activeTab: 'dashboard',
            guilds: [
                { id: 'ddun', name: 'ëš ì¹´ë¡±', type: 'ë©”ì¸ 1ê¸°', color: '#f472b6', icon: 'fa-crown', max: 200 },
                { id: 'ddung', name: 'ëš±ì¹´ë¡±', type: 'ë©”ì¸ 2ê¸°', color: '#fb7185', icon: 'fa-heart', max: 200 },
                { id: 'bam', name: 'ë°¤ì¹´ë¡±', type: 'ë¶€ìº 1ê¸°', color: '#6366f1', icon: 'fa-moon', max: 200 },
                { id: 'byeol', name: 'ë³„ì¹´ë¡±', type: 'ë¶€ìº 2ê¸°', color: '#facc15', icon: 'fa-star', max: 200 },
                { id: 'dal', name: 'ë‹¬ì¹´ë¡±', type: 'ë¶€ìº 3ê¸°', color: '#60a5fa', icon: 'fa-sun', max: 200 },
                { id: 'kkul', name: 'ê¿€ì¹´ë¡±', type: 'ë¶€ìº 4ê¸°', color: '#fbbf24', icon: 'fa-cube', max: 200 },
            ],
            members: [], history: [], bailHistory: [], suroHeaders: [],
            events: [],
            penaltyHistory: [],
            filters: { guild: 'all', search: '', sortField: 'name', sortOrder: 'asc' },
            analysisFilters: { sortField: 'avg', sortOrder: 'desc' },
            analysisGuild: 'ëš ì¹´ë¡±',
            calendarView: { year: new Date().getFullYear(), month: new Date().getMonth() },
            scriptUrl: APPS_SCRIPT_URL,
            guildRanks: initialGuildRanks,
            currentSelectedDate: null,
            pagination: { members: 1, analysis: 1 }
        };

        // --- HELPER FUNCTIONS ---
        window.showMsg = (text, type = 'info') => {
            const box = document.getElementById('msgBox'); if(!box) return;
            document.getElementById('msgText').innerText = text;
            box.classList.add('show'); setTimeout(() => box.classList.remove('show'), 3500);
        };
        window.showLoading = (show) => { document.getElementById('loadingOverlay')?.classList.toggle('force-hide', !show); };
        
        window.getAnniversaryInfo = () => {
            const now = new Date(); const diff = now - GUILD_START_DATE;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const years = Math.floor(days / 365);
            const remainingDays = days % 365;
            return { totalDays: days, years, remainingDays };
        };
        
        window.updateAnniversaryLabel = () => {
            const anniv = window.getAnniversaryInfo();
            const el = document.getElementById('anniversaryLabel');
            if (el) el.innerText = `ëš ì¹´ë¡±ì´ ìƒì„±ëœ ì§€ ${anniv.totalDays}ì¼ (${anniv.years}ë…„ ${anniv.remainingDays}ì¼)`;
        };

        window.calculateTotalSuro = (guildName) => {
            if (!appState.suroHeaders || appState.suroHeaders.length === 0) return 0;
            const lastHeader = appState.suroHeaders[appState.suroHeaders.length - 1];
            return appState.members.filter(m => m.guild === guildName).reduce((s, m) => s + (Number(m.suro?.[lastHeader]) || 0), 0);
        };

        window.getAdminBailStats = () => {
            const stats = {};
            appState.bailHistory.forEach(h => { const amount = parseInt(h.amount) || 0; stats[h.receiver] = (stats[h.receiver] || 0) + amount; });
            return Object.entries(stats).sort((a,b) => a[0].localeCompare(b[0], 'ko'));
        };

        function smartCompare(a, b, field, order) {
            let valA = a[field]; let valB = b[field];
            if (field === 'mainInfo') {
                valA = a.isMain ? a.name : (a.mainCharName || "");
                valB = b.isMain ? b.name : (b.mainCharName || "");
            }
            if (valA === valB) return 0;
            const numA = parseFloat(valA); const numB = parseFloat(valB);
            if (!isNaN(numA) && !isNaN(numB)) { return order === 'asc' ? numA - numB : numB - numA; }
            const strA = String(valA || ""); const strB = String(valB || "");
            const res = strA < strB ? -1 : 1;
            return order === 'asc' ? res : -res;
        }

        window.getNicknameIcon = (role) => {
            if (role === 'ë§ˆì¹´ë¡±') return '<i class="fas fa-crown text-blue-500 mr-2 shadow-sm"></i>';
            if (role === 'ë‹¤ì¿ ì•„ì¦ˆ') return '<i class="fas fa-crown text-pink-500 mr-2 shadow-sm"></i>';
            return '<span class="w-3 h-3 rounded-full bg-gray-200 mr-2 inline-block"></span>';
        };

        function formatRankWithSuffix(rank) {
            if (!rank) return '-';
            const special = ['í¬ë¼ìš´', 'íŒŒë¥´í˜', 'í‹°ë¼ë¯¸ìŠˆ', 'í¬ë¡œì¹¸ìŠˆ'];
            if (special.includes(rank)) return `${rank} <span class="text-[8.5px] text-blue-500 font-bold tracking-tighter">(ì•„ì¸ìŠˆí˜ë„ˆ)</span>`;
            return rank;
        }

        // --- CORE API ---
        window.fetchMembers = async () => {
            window.showLoading(true);
            try {
                const targetUrl = appState.scriptUrl + "?t=" + new Date().getTime();
                const response = await fetch(targetUrl, { 
                    method: 'GET', 
                    mode: 'cors', 
                    cache: 'no-cache',
                    redirect: 'follow'
                });
                const json = await response.json();
                if (json.status === "success") {
                    appState.members = (json.data.members || []).map(m => ({...m, id: String(m.id)})).filter(m => m.name && m.name.trim() !== "");
                    appState.history = json.data.history || [];
                    appState.suroHeaders = json.data.suroHeaders || [];
                    appState.bailHistory = json.data.bailHistory || [];
                    appState.events = json.data.events || [];
                    appState.penaltyHistory = json.data.penaltyHistory || [];
                    
                    const countEl = document.getElementById('totalMembersCount');
                    if (countEl) {
                        const counts = {};
                        appState.guilds.forEach(g => counts[g.name] = 0);
                        appState.members.forEach(m => {
                            if (counts[m.guild] !== undefined) counts[m.guild]++;
                        });
                        
                        const aliases = { 'ëš ì¹´ë¡±': 'ëš ', 'ëš±ì¹´ë¡±': 'ëš±', 'ë°¤ì¹´ë¡±': 'ë°¤', 'ë³„ì¹´ë¡±': 'ë³„', 'ë‹¬ì¹´ë¡±': 'ë‹¬', 'ê¿€ì¹´ë¡±': 'ê¿€' };
                        const text = appState.guilds.map(g => {
                            const name = aliases[g.name] || g.name.substring(0, 1);
                            return `${name}:${counts[g.name]}`;
                        }).join(' ');
                        
                        countEl.innerText = text;
                    }
                    
                    window.updateAnniversaryLabel();
                    window.router(appState.activeTab);
                } else {
                    window.showMsg("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", "error");
                }
            } catch (e) { 
                console.error("Fetch Error:", e); 
                window.showMsg("ë°ì´í„° ì—°ë™ ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.", "error"); 
            }
            window.showLoading(false);
        };

        // --- ROUTER ---
        window.router = (tab) => {
            appState.activeTab = tab;
            const content = document.getElementById('contentArea'); if(!content) return;
            content.innerHTML = '';
            document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.target === tab));
            const titles = { dashboard: 'ê¸¸ë“œ í˜„í™©íŒ', members: 'ê¸¸ë“œì› ëª…ë‹¨', analysis: 'ìˆ˜ë¡œ ë¶„ì„', bail: 'ë³´ì„ê¸ˆ í˜„í™©', penalty: 'ë²Œì  ê´€ë¦¬ í˜„í™©' };
            document.getElementById('pageTitle').innerText = titles[tab] || '';
            if (tab === 'dashboard') window.renderDashboard(content);
            else if (tab === 'members') window.renderMembers(content);
            else if (tab === 'analysis') window.renderAnalysis(content, appState.analysisGuild);
            else if (tab === 'bail') window.renderBail(content);
            else if (tab === 'penalty') window.renderPenalty(content);
        };

        // --- DASHBOARD ---
        window.renderDashboard = (container) => {
            const anniv = window.getAnniversaryInfo(); const ddunT = window.calculateTotalSuro('ëš ì¹´ë¡±'); const ddungT = window.calculateTotalSuro('ëš±ì¹´ë¡±');
            // Admin Bail Stats - Masked for public view in list, but kept for total context logic if needed
            // For public dashboard we will show just the list of "Anonymized" top holders or just hide it.
            // Requirement says "Bail Management -> Numbers all open". So we show amounts.
            
            const adminBailStats = window.getAdminBailStats();
            // Masking Admin Names for public view
            const adminBailHtml = adminBailStats.map(([name, count]) => `<div class="flex justify-between items-center py-2 border-b border-gray-50 last:border-0"><span class="text-[11px] font-bold text-gray-400">***</span><span class="text-[11px] font-black text-pink-500">${count}ê°œ</span></div>`).join('') || '<p class="text-[10px] text-gray-300 italic text-center py-4">ë³´ì„ê¸ˆ ë‚´ì—­ ì—†ìŒ</p>';
            
            container.innerHTML = `
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8 fade-in shrink-0">
                <div class="flex flex-col gap-6">
                    <div class="flex gap-6 h-40">
                        <div onclick="router('analysis'); renderAnalysis(document.getElementById('contentArea'), 'ëš ì¹´ë¡±')" class="flex-1 bg-gradient-to-br from-pink-500 to-rose-500 rounded-[2.5rem] p-8 shadow-lg text-white cursor-pointer hover:scale-[1.02] transition-transform relative overflow-hidden flex flex-col justify-center border-none">
                            <div class="absolute top-0 right-0 p-4 opacity-20 text-5xl"><i class="fas fa-crown"></i></div>
                            <h3 class="text-sm font-bold opacity-80 uppercase tracking-widest text-center">ëš ì¹´ë¡± ìˆ˜ë¡œ ì´ì </h3>
                            <p class="text-3xl font-black tracking-tighter text-center">${ddunT.toLocaleString()}</p>
                        </div>
                        <div onclick="router('analysis'); renderAnalysis(document.getElementById('contentArea'), 'ëš±ì¹´ë¡±')" class="flex-1 bg-white border border-gray-100 rounded-[2.5rem] p-8 shadow-sm text-gray-800 cursor-pointer hover:border-pink-200 transition-all flex flex-col justify-center">
                            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest text-center">ëš±ì¹´ë¡± ìˆ˜ë¡œ ì´ì </h3>
                            <p class="text-3xl font-black tracking-tighter text-pink-500 text-center">${ddungT.toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 min-h-[340px] shadow-sm flex flex-col">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">ğŸ“…</span>
                                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Guild Calendar</h3>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-2 bg-gray-50 px-3 py-1.5 rounded-2xl border border-gray-100">
                                    <button onclick="moveMonth(-1)" class="w-6 h-6 flex items-center justify-center rounded-lg hover:bg-white hover:text-pink-500 transition-all text-gray-400"><i class="fas fa-chevron-left text-[10px]"></i></button>
                                    <span class="text-[11px] font-bold text-gray-600 w-16 text-center">${appState.calendarView.year}.${String(appState.calendarView.month + 1).padStart(2, '0')}</span>
                                    <button onclick="moveMonth(1)" class="w-6 h-6 flex items-center justify-center rounded-lg hover:bg-white hover:text-pink-500 transition-all text-gray-400"><i class="fas fa-chevron-right text-[10px]"></i></button>
                                </div>
                            </div>
                        </div>
                        ${window.renderCalendar()}
                    </div>
                </div>
                <div class="flex flex-col gap-8 h-full">
                    <div class="bg-white p-10 rounded-[3rem] shadow-sm border border-gray-100 flex flex-col h-[300px] overflow-hidden shrink-0">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest">ì§ì—… ë¶„í¬ë„</h3>
                            <select onchange="window.updateJobChart(this.value)" class="bg-gray-50 rounded-xl px-3 py-1.5 text-xs font-bold outline-none cursor-pointer hover:bg-gray-100">
                                <option value="all">ì „ì²´</option>${appState.guilds.map(g => `<option value="${g.name}">${g.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex-1 overflow-y-auto no-scrollbar">
                            <div style="min-height: 250px;"><canvas id="jobChart"></canvas></div>
                        </div>
                    </div>
                    <div class="bg-white p-10 rounded-[3rem] shadow-sm border border-gray-100 flex flex-col flex-1 min-h-[200px] overflow-hidden">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest">ê°„ë¶€ì§„ ë³´ì„ê¸ˆ í˜„í™©</h3>
                            <i class="fas fa-gem text-pink-300"></i>
                        </div>
                        <div class="flex-1 overflow-y-auto no-scrollbar pr-2">${adminBailHtml}</div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 fade-in shrink-0">
                ${appState.guilds.map(g => { 
                    const count = appState.members.filter(m => m.guild === g.name).length; 
                    const pct = Math.min((count / g.max) * 100, 100); 
                    return `<div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm hover:shadow-xl transition-all cursor-pointer group" onclick="filterByGuild('${g.name}')"><div class="flex justify-between items-start mb-6"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-gray-50 rounded-2xl flex items-center justify-center text-gray-400 group-hover:bg-pink-50 group-hover:text-pink-500 transition-colors"><i class="fas ${g.icon}"></i></div><div><span class="block font-bold text-lg text-gray-800 group-hover:text-pink-500">${g.name}</span><span class="text-[10px] text-gray-400 font-bold">${g.type}</span></div></div></div><div class="w-full bg-gray-50 rounded-full h-1.5 overflow-hidden"><div class="h-full bg-pink-500 transition-all duration-1000" style="width:${pct}%"></div></div><p class="text-[10px] text-gray-400 font-bold mt-2 text-right">${count} / ${g.max}</p></div>`; 
                }).join('')}
            </div>`;
            setTimeout(() => window.updateJobChart('all'), 0);
        };

        // --- CALENDAR LOGIC ---
        window.moveMonth = (delta) => {
            let newMonth = appState.calendarView.month + delta;
            let newYear = appState.calendarView.year;
            if (newMonth < 0) { newMonth = 11; newYear--; }
            else if (newMonth > 11) { newMonth = 0; newYear++; }
            appState.calendarView.month = newMonth;
            appState.calendarView.year = newYear;
            window.router('dashboard');
        };

        window.renderCalendar = () => { 
            const year = appState.calendarView.year, month = appState.calendarView.month; 
            const first = new Date(year, month, 1).getDay();
            const last = new Date(year, month + 1, 0).getDate(); 
            const prevLast = new Date(year, month, 0).getDate();
            const today = new Date();
            
            let html = `<div class="calendar-grid"><div class="calendar-head text-red-400">ì¼</div><div class="calendar-head">ì›”</div><div class="calendar-head">í™”</div><div class="calendar-head">ìˆ˜</div><div class="calendar-head text-pink-500">ëª©</div><div class="calendar-head">ê¸ˆ</div><div class="calendar-head text-blue-400">í† </div>`; 
            
            for(let i=first; i>0; i--) {
                html += `<div class="calendar-day not-current"><span>${prevLast - i + 1}</span></div>`;
            }

            for(let d=1; d<=last; d++) { 
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayEvent = appState.events.find(e => {
                    const eDate = (e.date || '').trim();
                    return eDate === dateStr || eDate.startsWith(dateStr);
                });
                const isToday = today.getFullYear()===year && today.getMonth()===month && today.getDate()===d;
                const isThursday = new Date(year, month, d).getDay() === 4;

                let cls = "calendar-day text-gray-600";
                if(isThursday) cls += " thursday";
                if(isToday) cls += " today";
                
                let eventHtml = '';
                if(dayEvent) {
                    eventHtml += `<div class="event-dot"></div>`;
                    eventHtml += `<div class="event-snippet" title="${dayEvent.title}">${dayEvent.title}</div>`;
                }
                html += `<div class="${cls}" onclick="window.showEventDetail('${dateStr}')"><span>${d}</span>${eventHtml}</div>`; 
            } 
            
            const totalCells = first + last;
            const extraCells = (7 - (totalCells % 7)) % 7;
            for(let i=1; i<=extraCells; i++) {
                html += `<div class="calendar-day not-current"><span>${i}</span></div>`;
            }

            return html + `</div>`; 
        };

        window.showEventDetail = (dateStr) => {
            appState.currentSelectedDate = dateStr;
            const modal = document.getElementById('eventDetailModal');
            const dateDisplay = document.getElementById('eventDetailDate');
            const titleDisplay = document.getElementById('eventTitleDisplay');
            const contentDisplay = document.getElementById('eventContentDisplay');
            
            const existing = appState.events.find(e => {
                const eDate = (e.date || '').trim();
                return eDate === dateStr || eDate.startsWith(dateStr);
            });
            
            dateDisplay.innerText = dateStr;
            titleDisplay.innerText = existing ? existing.title : "ì¼ì • ì—†ìŒ";
            contentDisplay.innerText = existing ? existing.content : "ë“±ë¡ëœ ìƒì„¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.";
            modal.classList.remove('hidden');
        };
        
        // --- PAGINATION HELPERS ---
        window.changePage = (type, delta) => {
            appState.pagination[type] += delta;
            if (type === 'members') window.updateMemberTable();
            if (type === 'analysis') window.renderAnalysis(document.getElementById('contentArea'), appState.analysisGuild);
        };

        // --- ANALYSIS ---
        window.renderAnalysis = (container, gName) => {
            appState.analysisGuild = gName;
            const targets = appState.members.filter(m => m.guild === gName);
            const recentHeaders = appState.suroHeaders.slice(-5);
            const currentHeader = recentHeaders[recentHeaders.length - 1];
            const total = window.calculateTotalSuro(gName);

            const zeroPointMembers = targets.filter(m => (Number(m.suro?.[currentHeader]) || 0) === 0);
            const processedList = targets.map(m => {
                const scores = recentHeaders.map(h => Number(m.suro?.[h]) || 0);
                const avg = scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1) : 0;
                return { ...m, avg: Number(avg), recentScores: scores };
            });

            processedList.sort((a, b) => {
                const f = appState.analysisFilters.sortField;
                const o = appState.analysisFilters.sortOrder;
                if (f === 'avg') return o === 'asc' ? a.avg - b.avg : b.avg - a.avg;
                if (f === 'score') {
                    const vA = Number(a.suro?.[currentHeader]) || 0;
                    const vB = Number(b.suro?.[currentHeader]) || 0;
                    return o === 'asc' ? vA - vB : vB - vA;
                }
                return smartCompare(a, b, f, o);
            });

            const totalItems = processedList.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            if (appState.pagination.analysis > totalPages && totalPages > 0) appState.pagination.analysis = totalPages;
            if (appState.pagination.analysis < 1) appState.pagination.analysis = 1;
            
            const pageData = processedList.slice((appState.pagination.analysis - 1) * ITEMS_PER_PAGE, appState.pagination.analysis * ITEMS_PER_PAGE);
            const sortIcon = (f) => appState.analysisFilters.sortField === f ? (appState.analysisFilters.sortOrder === 'asc' ? ' <i class="fas fa-sort-up"></i>' : ' <i class="fas fa-sort-down"></i>') : '';

            container.innerHTML = `
            <div class="flex flex-col gap-6 fade-in h-full overflow-hidden">
                <div class="flex gap-2 overflow-x-auto no-scrollbar shrink-0">
                    ${appState.guilds.map(g => `<button onclick="window.renderAnalysis(document.getElementById('contentArea'), '${g.name}')" class="px-6 py-2.5 rounded-xl text-xs font-bold transition-all ${g.name === gName ? 'bg-pink-500 text-white shadow-lg' : 'bg-white text-gray-500 border border-gray-100'}">${g.name}</button>`).join('')}
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 shrink-0 font-bold">
                    <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm flex flex-col justify-center items-center">
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-1">ì „ì²´ ì´ì </p>
                        <h4 class="text-3xl font-black text-gray-800 tracking-tighter">${total.toLocaleString()}</h4>
                    </div>
                    <div class="bg-red-50 p-6 rounded-[2rem] border border-red-100 shadow-sm flex flex-col justify-center items-center">
                        <p class="text-[10px] text-red-500 font-bold uppercase tracking-widest mb-1">ğŸš¨ ì¤‘ìš” ì•Œë¦¼ (ë¯¸ì°¸ì—¬)</p>
                        <h4 class="text-3xl font-black text-red-600 tracking-tighter">${zeroPointMembers.length}ëª…</h4>
                    </div>
                    <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm flex flex-col justify-center items-center">
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-1">ìµœê·¼ ë°ì´í„° ì£¼ì°¨</p>
                        <h4 class="text-sm font-bold text-gray-700">${currentHeader ? currentHeader.split(' ')[0] : 'ë°ì´í„° ì—†ìŒ'}</h4>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1 min-h-0">
                    <div class="lg:col-span-1 bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm flex flex-col overflow-hidden">
                        <h3 class="text-xs font-bold text-gray-400 mb-6 uppercase tracking-widest">ì£¼ê°„ ì´ì  ì¶”ì´</h3>
                        <div class="flex-1 min-h-[200px]">
                            <canvas id="analysisChart"></canvas>
                        </div>
                    </div>

                    <div class="lg:col-span-2 bg-white rounded-[2.5rem] border border-gray-100 shadow-sm overflow-hidden flex flex-col">
                        <div class="p-6 border-b border-gray-50 flex justify-between items-center shrink-0">
                            <h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">ì¸í„°ë™í‹°ë¸Œ ë°ì´í„° í…Œì´ë¸”</h3>
                        </div>
                        <div class="flex-1 overflow-auto no-scrollbar">
                            <table class="w-full text-left text-xs whitespace-nowrap">
                                <thead class="bg-gray-50 font-bold text-[10px] text-gray-500 uppercase sticky top-0 z-10 border-b border-gray-100">
                                    <tr>
                                        <th class="p-4 w-12 text-center">RANK</th>
                                        <th class="p-4 sortable" onclick="window.setAnalysisSort('name')">ìºë¦­í„°ëª…${sortIcon('name')}</th>
                                        <th class="p-4 text-center sortable bg-pink-50/50" onclick="window.setAnalysisSort('avg')">í‰ê· ${sortIcon('avg')}</th>
                                        ${recentHeaders.map(h => `<th class="p-4 text-right font-medium">${h.split('~')[0].trim()}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-50 font-bold">
                                    ${pageData.map((m, i) => {
                                        const globalIndex = (appState.pagination.analysis - 1) * ITEMS_PER_PAGE + i + 1;
                                        return `
                                        <tr class="hover:bg-gray-50 transition-colors h-12">
                                            <td class="p-4 text-center text-gray-300">${globalIndex}</td>
                                            <td class="p-4 text-gray-800 flex items-center leading-none">
                                                ${window.getNicknameIcon(m.role)}${m.name}
                                            </td>
                                            <td class="p-4 text-center text-pink-500 bg-pink-50/20">${m.avg.toLocaleString()}</td>
                                            ${m.recentScores.map(s => `
                                                <td class="p-4 text-right font-mono score-cell ${s === 0 ? 'score-zero' : 'text-gray-400'}">
                                                    ${s > 0 ? s.toLocaleString() : '0'}
                                                </td>
                                            `).join('')}
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="p-3 border-t border-gray-100 flex justify-center items-center gap-4 bg-gray-50/50">
                            <button onclick="changePage('analysis', -1)" class="w-8 h-8 flex items-center justify-center rounded-xl bg-white border border-gray-200 text-gray-500 hover:bg-pink-50 hover:text-pink-500 hover:border-pink-200 disabled:opacity-30 disabled:hover:bg-white" ${appState.pagination.analysis <= 1 ? 'disabled' : ''}><i class="fas fa-chevron-left text-[10px]"></i></button>
                            <span class="text-xs font-bold text-gray-500">${appState.pagination.analysis} / ${totalPages || 1}</span>
                            <button onclick="changePage('analysis', 1)" class="w-8 h-8 flex items-center justify-center rounded-xl bg-white border border-gray-200 text-gray-500 hover:bg-pink-50 hover:text-pink-500 hover:border-pink-200 disabled:opacity-30 disabled:hover:bg-white" ${appState.pagination.analysis >= totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right text-[10px]"></i></button>
                        </div>
                    </div>
                </div>
            </div>`;

            const ctx = document.getElementById('analysisChart');
            if(!ctx) return;
            if(analysisChartInstance) analysisChartInstance.destroy();
            analysisChartInstance = new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels: recentHeaders.map(h => {
                        const parts = h ? h.split('-') : [];
                        if(parts.length >= 3) return parts[1] + '-' + parts[2].substring(0,2);
                        return h;
                    }), 
                    datasets: [{ 
                        label: 'ê¸¸ë“œ ì´ì ', 
                        data: recentHeaders.map(h => appState.members.filter(m => m.guild === gName).reduce((s, m) => s + (Number(m.suro?.[h]) || 0), 0)), 
                        borderColor: '#ec4899', 
                        borderWidth: 3, 
                        pointRadius: 4, 
                        pointBackgroundColor: '#fff', 
                        tension: 0.4, 
                        fill: true, 
                        backgroundColor: 'rgba(236, 72, 153, 0.05)' 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        y: { display: false }, 
                        x: { grid: { display: false }, ticks: { font: { size: 10, weight: 'bold' } } } 
                    } 
                } 
            });
        };
        
        window.setAnalysisSort = (f) => { 
            if(appState.analysisFilters.sortField === f) appState.analysisFilters.sortOrder = appState.analysisFilters.sortOrder === 'asc' ? 'desc' : 'asc'; 
            else { appState.analysisFilters.sortField = f; appState.analysisFilters.sortOrder = (f==='score'||f==='rank'||f==='avg') ? 'desc' : 'asc'; } 
            appState.pagination.analysis = 1; 
            window.renderAnalysis(document.getElementById('contentArea'), appState.analysisGuild); 
        };

        window.updateJobChart = (target) => {
            const ctx = document.getElementById('jobChart'); if(!ctx) return;
            const targets = target === 'all' ? appState.members : appState.members.filter(m => m.guild === target);
            const counts = {}; targets.forEach(m => { const j = m.class || 'ë¯¸ì„¤ì •'; counts[j] = (counts[j] || 0) + 1; });
            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
            if(jobChartInstance) jobChartInstance.destroy();
            jobChartInstance = new Chart(ctx, { type: 'bar', data: { labels: sorted.map(j => j[0]), datasets: [{ label: 'ì¸ì›', data: sorted.map(j => j[1]), backgroundColor: '#f472b6', borderRadius: 4, barThickness: 12 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { precision: 0 } } } } });
        };

        // --- MEMBERS VIEW (READ ONLY) ---
        window.renderMembers = (container) => {
            container.innerHTML = `
            <div class="flex flex-col gap-3 fade-in h-full">
                <!-- Compact Header Control Panel -->
                <div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col xl:flex-row items-center gap-4 shrink-0">
                    <!-- Guild Tabs -->
                    <div class="flex overflow-x-auto no-scrollbar w-full xl:w-auto gap-2 shrink-0">
                        <button onclick="window.filterByGuild('all')" class="shrink-0 px-4 py-2 rounded-xl text-xs font-bold transition-all ${appState.filters.guild === 'all' ? 'bg-gray-800 text-white shadow-md' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">ì „ì²´</button>
                        ${appState.guilds.map(g => `<button onclick="window.filterByGuild('${g.name}')" class="shrink-0 px-4 py-2 rounded-xl text-xs font-bold transition-all ${appState.filters.guild === g.name ? 'bg-pink-500 text-white shadow-md' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">${g.name}</button>`).join('')}
                    </div>
                    
                    <!-- Search Bar (Takes available width) -->
                    <div class="relative flex-1 w-full">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                        <input type="text" oninput="window.handleSearch(this.value)" value="${appState.filters.search}" class="w-full pl-10 pr-4 py-2.5 bg-gray-50 border border-gray-100 rounded-xl outline-none text-xs font-bold shadow-inner focus:ring-2 focus:ring-pink-50 transition-all" placeholder="ë‹‰ë„¤ì„, ì§ìœ„, ì§ì—… ê²€ìƒ‰">
                    </div>
                </div>

                <!-- Table Area -->
                <div id="memberTableContainer" class="bg-white rounded-2xl border border-gray-100 overflow-hidden shadow-sm flex-1 min-h-0 flex flex-col"></div>
            </div>`;
            window.updateMemberTable();
        };

        window.updateMemberTable = () => {
            const container = document.getElementById('memberTableContainer'); if(!container) return;
            const term = appState.filters.search.toLowerCase();
            const filtered = appState.members.filter(m => { 
                const gMatch = appState.filters.guild === 'all' || m.guild === appState.filters.guild; 
                const sMatch = m.name.toLowerCase().includes(term) || 
                               (m.class||'').toLowerCase().includes(term) || 
                               (m.role||'').toLowerCase().includes(term) ||
                               (m.mainCharName || '').toLowerCase().includes(term) || 
                               (m.isMain && m.name.toLowerCase().includes(term)); 
                return gMatch && sMatch; 
            });
            filtered.sort((a, b) => smartCompare(a, b, appState.filters.sortField, appState.filters.sortOrder));
            
            // Pagination Logic
            const totalItems = filtered.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            if (appState.pagination.members > totalPages && totalPages > 0) appState.pagination.members = totalPages;
            if (appState.pagination.members < 1) appState.pagination.members = 1;
            
            const pageData = filtered.slice((appState.pagination.members - 1) * ITEMS_PER_PAGE, appState.pagination.members * ITEMS_PER_PAGE);

            const sortIcon = (f) => appState.filters.sortField === f ? (appState.filters.sortOrder === 'asc' ? ' <i class="fas fa-sort-up"></i>' : ' <i class="fas fa-sort-down"></i>') : '';
            let html = `<div class="overflow-y-auto flex-1"><table class="w-full text-left min-w-[900px] text-xs whitespace-nowrap"><thead class="bg-gray-50 text-[10px] font-bold text-gray-500 border-b border-gray-100 sticky top-0 z-10"><tr><th class="p-4 text-center w-16">No.</th><th class="p-4 sortable" onclick="window.handleSort('name')">ë‹‰ë„¤ì„${sortIcon('name')}</th><th class="p-4 sortable" onclick="window.handleSort('mainInfo')">ë³¸ìº ì •ë³´${sortIcon('mainInfo')}</th><th class="p-4 sortable" onclick="window.handleSort('guild')">ì†Œì†${sortIcon('guild')}</th><th class="p-4 sortable" onclick="window.handleSort('role')">ì§ìœ„${sortIcon('role')}</th><th class="p-4 sortable" onclick="window.handleSort('class')">ì§ì—…${sortIcon('class')}</th></tr></thead><tbody class="divide-y divide-gray-50 text-gray-600 font-bold">`;
            
            pageData.forEach((m, idx) => {
                const globalIndex = (appState.pagination.members - 1) * ITEMS_PER_PAGE + idx + 1;
                const mainName = m.isMain ? m.name : (m.mainCharName || '-'); 
                const mainMem = appState.members.find(x => x.name === mainName);
                const mainRankHtml = mainMem ? formatRankWithSuffix(mainMem.role) : '-';
                
                // Color logic for Main Info Cell
                let mainInfoStyle = "";
                let mainInfoTextClass = "text-gray-700";
                let subInfoTextClass = "text-gray-400";
                
                const targetRole = mainMem ? mainMem.role : (m.isMain ? m.role : '');

                if (['í‹°ë¼ë¯¸ìŠˆ', 'íŒŒë¥´í˜', 'í¬ë¼ìš´'].includes(targetRole)) {
                    mainInfoStyle = "background-color: #0066FF;";
                    mainInfoTextClass = "text-white";
                    subInfoTextClass = "text-white opacity-80";
                } else if (targetRole === 'í¬ë¡œì¹¸ìŠˆ') {
                    mainInfoStyle = "background-color: #92D050;";
                    mainInfoTextClass = "text-black";
                    subInfoTextClass = "text-black opacity-80";
                }

                let roleHtml = `<span class="text-[10px]">${m.role}</span>`;
                if (m.role === 'ì•„ì¸ìŠˆí˜ë„ˆ') {
                    roleHtml = `<span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold text-white tracking-tight shadow-sm" style="background-color: #FF99FF; text-shadow: 0 1px 1px rgba(0,0,0,0.1);">${m.role}</span>`;
                }

                html += `<tr class="hover:bg-pink-50/20 group transition-colors h-12">
                    <td class="p-3 text-center text-gray-400 text-[11px]">${globalIndex}</td>
                    <td class="p-3 font-bold text-gray-800 flex items-center h-full leading-none">${window.getNicknameIcon(m.role)}<span class="text-sm tracking-tight">${m.name}</span></td>
                    <td class="p-3 leading-tight">
                        <div class="rounded-xl p-2 transition-colors -m-1" style="${mainInfoStyle}">
                            <span class="block text-[11px] font-bold ${mainInfoTextClass}">${mainName}</span>
                            <span class="text-[9px] font-medium ${subInfoTextClass}">${mainRankHtml}</span>
                        </div>
                    </td>
                    <td class="p-3">${m.guild}</td>
                    <td class="p-3">${roleHtml}</td>
                    <td class="p-3"><span class="text-[10px] text-gray-400">${m.class||'-'}</span></td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
            
            // Add Pagination Controls
            html += `<div class="p-3 border-t border-gray-100 flex justify-center items-center gap-4 bg-gray-50/50">
                <button onclick="changePage('members', -1)" class="w-8 h-8 flex items-center justify-center rounded-xl bg-white border border-gray-200 text-gray-500 hover:bg-pink-50 hover:text-pink-500 hover:border-pink-200 disabled:opacity-30 disabled:hover:bg-white" ${appState.pagination.members <= 1 ? 'disabled' : ''}><i class="fas fa-chevron-left text-[10px]"></i></button>
                <span class="text-xs font-bold text-gray-500">${appState.pagination.members} / ${totalPages || 1}</span>
                <button onclick="changePage('members', 1)" class="w-8 h-8 flex items-center justify-center rounded-xl bg-white border border-gray-200 text-gray-500 hover:bg-pink-50 hover:text-pink-500 hover:border-pink-200 disabled:opacity-30 disabled:hover:bg-white" ${appState.pagination.members >= totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right text-[10px]"></i></button>
            </div>`;

            container.innerHTML = html;
        };

        // --- BAIL MANAGEMENT (READ ONLY) ---
        window.renderBail = (container) => {
            const adminStats = window.getAdminBailStats();
            // Masked name for history
            const historyRows = [...appState.bailHistory].reverse().map(h => `<tr class="hover:bg-gray-50 border-b border-gray-50 h-12 transition-colors font-bold text-xs"><td class="p-4 font-mono text-gray-400 text-[10px]">${h.date}</td><td class="p-4 text-gray-700 masked-text">******</td><td class="p-4 text-blue-500 masked-text">******</td><td class="p-4 text-right text-pink-500">${h.amount}ê°œ</td></tr>`).join('');
            // Masked name for admin stats
            const statsHtml = adminStats.map(([name, count]) => `<div class="bg-gray-50 rounded-2xl p-4 flex justify-between items-center border border-gray-100 hover:bg-white transition-all shadow-sm"><span class="font-bold text-gray-400 text-xs masked-text">******</span><span class="font-black text-pink-500 text-lg">${count}ê°œ</span></div>`).join('');
            
            container.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 fade-in h-full">
            <div class="lg:col-span-1 bg-white p-10 rounded-[3rem] border border-gray-100 shadow-sm flex flex-col h-full overflow-hidden">
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 tracking-tight">ê°„ë¶€ë³„ ìˆ˜ë ¹ ì´ê³„</h3>
                    <p class="text-xs text-gray-400 mt-1 uppercase font-bold tracking-widest">EXECUTIVE BAIL STATS</p>
                </div>
                <div class="space-y-6 flex-1 overflow-y-auto no-scrollbar pb-6">
                    <div class="grid grid-cols-1 gap-2">${statsHtml || '<p class="text-[10px] text-gray-300 italic text-center">ë°ì´í„° ì—†ìŒ</p>'}</div>
                </div>
            </div>
            <div class="lg:col-span-2 bg-white rounded-[3rem] border border-gray-100 shadow-sm flex flex-col overflow-hidden h-full">
                <div class="p-8 border-b border-gray-50 flex justify-between items-center">
                    <h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">ìµœê·¼ ë³´ì„ê¸ˆ ë‚©ë¶€ ì´ë ¥ (yy-mm-dd)</h3>
                    <span class="text-[10px] text-gray-400 font-bold italic">Total: ${appState.bailHistory.length}</span>
                </div>
                <div class="flex-1 overflow-y-auto no-scrollbar">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-gray-50 text-[10px] font-bold text-gray-500 uppercase sticky top-0">
                            <tr>
                                <th class="p-5">ë‚ ì§œ</th>
                                <th class="p-5">ë‚©ë¶€ì (ë¹„ê³µê°œ)</th>
                                <th class="p-5">ìˆ˜ë ¹ì (ë¹„ê³µê°œ)</th>
                                <th class="p-5 text-right">ìˆ˜ëŸ‰</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-50">${historyRows || '<tr><td colspan="4" class="p-20 text-center text-gray-300 font-bold italic">ë‚´ì—­ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</td></tr>'}</tbody>
                    </table>
                </div>
            </div>
            </div>`;
        };

        // --- PENALTY MANAGEMENT (READ ONLY) ---
        window.renderPenalty = (container) => {
            // Calculate penalty counts
            const penaltyCounts = {};
            appState.penaltyHistory.forEach(h => {
                penaltyCounts[h.name] = (penaltyCounts[h.name] || 0) + Number(h.points);
            });
            const activePenalties = Object.entries(penaltyCounts).filter(([name, pts]) => pts > 0);

            const penaltyRows = [...appState.penaltyHistory].map(h => {
                return `
                <tr class="hover:bg-gray-50 border-b border-gray-50 h-12 transition-colors font-bold text-xs">
                    <td class="p-4 font-mono text-gray-400 text-[10px] masked-text">**-**-**</td>
                    <td class="p-4 text-gray-700 masked-text">******</td>
                    <td class="p-4 text-red-500">${h.points}ì </td>
                    <td class="p-4 text-gray-300 text-[11px] masked-text">ë¹„ê³µê°œ ì‚¬ìœ </td>
                </tr>
            `}).join('');

            container.innerHTML = `
            <div class="grid grid-cols-1 gap-8 fade-in h-full">
                <!-- Status & History Only (Form Removed) -->
                <div class="flex flex-col gap-6 h-full overflow-hidden">
                    <!-- Current Targets Card -->
                    <div class="bg-white p-8 rounded-[3rem] border border-gray-100 shadow-sm shrink-0 min-h-[160px]">
                        <div class="mb-4">
                            <h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">í˜„ì¬ ë²Œì  ê´€ë¦¬ ëŒ€ìƒì í˜„í™©</h3>
                        </div>
                        <div class="flex gap-4 overflow-x-auto no-scrollbar pb-2">
                            ${activePenalties.length > 0 
                                ? activePenalties.map(([name, pts]) => `
                                    <div class="flex items-center gap-3 bg-red-50 pl-2 pr-5 py-2 rounded-full border border-red-100 shrink-0">
                                        <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-red-500 font-bold text-xs shadow-sm">${pts}</div>
                                        <span class="text-xs font-bold text-red-300 masked-text">******</span>
                                    </div>
                                  `).join('')
                                : '<p class="text-xs text-gray-300 font-bold italic w-full">í˜„ì¬ ë²Œì ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                            }
                        </div>
                    </div>

                    <!-- History Table -->
                    <div class="bg-white rounded-[3rem] border border-gray-100 shadow-sm flex flex-col flex-1 overflow-hidden">
                        <div class="p-8 border-b border-gray-50 flex justify-between items-center shrink-0">
                            <h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">ìƒì„¸ ë¶€ì—¬ ì´ë ¥</h3>
                        </div>
                        <div class="flex-1 overflow-y-auto no-scrollbar">
                            <table class="w-full text-left text-xs whitespace-nowrap">
                                <thead class="bg-gray-50 text-[10px] font-bold text-gray-500 uppercase sticky top-0">
                                    <tr>
                                        <th class="p-5">ë‚ ì§œ (ë¹„ê³µê°œ)</th>
                                        <th class="p-5">ëŒ€ìƒì (ë¹„ê³µê°œ)</th>
                                        <th class="p-5">ì ìˆ˜</th>
                                        <th class="p-5">ë¶€ì—¬ ì‚¬ìœ  (ë¹„ê³µê°œ)</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-50">
                                    ${penaltyRows || '<tr><td colspan="4" class="p-20 text-center text-gray-300 font-bold italic">ë²Œì  ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>`;
        };

        window.handleSearch = (v) => { appState.filters.search = v; appState.pagination.members = 1; window.updateMemberTable(); };
        window.filterByGuild = (g) => { appState.filters.guild = g; appState.pagination.members = 1; if(appState.activeTab === 'members') window.renderMembers(document.getElementById('contentArea')); else window.updateMemberTable(); };
        window.handleSort = (field) => { if(appState.filters.sortField === field) appState.filters.sortOrder = appState.filters.sortOrder === 'asc' ? 'desc' : 'asc'; else { appState.filters.sortField = field; appState.filters.sortOrder = 'asc'; } appState.pagination.members = 1; window.updateMemberTable(); };
        window.closeModal = (id) => { document.getElementById(id)?.classList.add('hidden'); };
        
        function initSidebar() {
            const sb = document.getElementById('sidebar'), ov = document.getElementById('sidebarOverlay');
            document.getElementById('openSidebar').onclick = () => { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); };
            document.getElementById('closeSidebar').onclick = () => { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); };
            ov.onclick = () => { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); };
        }

        document.addEventListener('DOMContentLoaded', () => { initSidebar(); window.fetchMembers(); });
    </script>
</body>
</html>
