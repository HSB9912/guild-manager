<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëš ì¹´ë¡± ê¸¸ë“œ í˜„í™© (Public View)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .chart-container { position: relative; width: 100%; height: 300px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #fbcfe8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #f472b6; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        th.sortable { cursor: pointer; user-select: none; transition: background 0.2s; position: relative; }
        th.sortable:hover { background-color: #fdf2f8 !important; color: #db2777 !important; }
        .force-hide { display: none !important; }
        #loadingOverlay { position: fixed; inset: 0; background: white; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .nav-item.active { background-color: #fdf2f8; color: #ec4899; box-shadow: inset 4px 0 0 #ec4899; }
        #msgBox { transition: all 0.3s ease; transform: translateY(100px); opacity: 0; pointer-events: none; }
        #msgBox.show { transform: translateY(0); opacity: 1; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; text-align: center; font-size: 0.75rem; }
        .calendar-day { padding: 0.25rem; border-radius: 0.75rem; position: relative; transition: all 0.2s; min-height: 48px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; aspect-ratio: 1/1; cursor: pointer; border: 1px solid transparent; }
        @media (min-width: 1024px) { .calendar-day { min-height: 56px; } }
        .calendar-day:hover { background-color: #f9fafb; border-color: #fbcfe8; }
        .calendar-day.today { background-color: #ec4899; color: white; font-weight: bold; }
        .calendar-day.thursday { color: #db2777; background-color: #fdf2f8; border: 1px solid #fbcfe8; font-weight: bold; }
        .calendar-day.not-current { opacity: 0.2; pointer-events: none; }
        .calendar-head { font-size: 0.7rem; font-weight: 800; color: #9ca3af; text-transform: uppercase; padding-bottom: 8px; }
        .event-dot { width: 4px; height: 4px; background-color: #ec4899; border-radius: 50%; margin-top: 2px; }
        .calendar-day.today .event-dot { background-color: white; }
        
        .event-snippet { 
            font-size: 10px; 
            color: #db2777; 
            opacity: 1; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            width: 100%; 
            margin-top: 3px; 
            line-height: 1.1; 
            font-weight: 800; 
            background-color: rgba(251, 207, 232, 0.3); 
            border-radius: 4px;
            padding: 1px 2px;
        }
        @media (min-width: 1024px) { .event-snippet { font-size: 11px; } }
        .calendar-day.today .event-snippet { color: white; background-color: rgba(255, 255, 255, 0.2); }

        .score-zero { background-color: #fee2e2 !important; color: #ef4444 !important; }
        .score-cell { transition: background 0.2s; }
        .score-cell:hover { background-color: #f8fafb; }

        /* Mobile Card Styles for Members */
        .member-card {
            background: white;
            border: 1px solid #f3f4f6;
            border-radius: 1.25rem;
            padding: 1rem;
            transition: all 0.2s;
        }
        .member-card:hover {
            border-color: #fbcfe8;
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.08);
        }

        /* Sticky first column for analysis table on mobile */
        .analysis-table-wrap table thead th:nth-child(1),
        .analysis-table-wrap table thead th:nth-child(2),
        .analysis-table-wrap table tbody td:nth-child(1),
        .analysis-table-wrap table tbody td:nth-child(2) {
            position: sticky;
            z-index: 20;
            background: inherit;
        }
        .analysis-table-wrap table thead th:nth-child(1),
        .analysis-table-wrap table tbody td:nth-child(1) {
            left: 0;
        }
        .analysis-table-wrap table thead th:nth-child(2),
        .analysis-table-wrap table tbody td:nth-child(2) {
            left: 50px;
        }
        .analysis-table-wrap table thead th:nth-child(1),
        .analysis-table-wrap table thead th:nth-child(2) {
            background: #f9fafb;
        }
        .analysis-table-wrap table tbody tr td:nth-child(1),
        .analysis-table-wrap table tbody tr td:nth-child(2) {
            background: white;
        }
        .analysis-table-wrap table tbody tr:hover td:nth-child(1),
        .analysis-table-wrap table tbody tr:hover td:nth-child(2) {
            background: #f9fafb;
        }
        .analysis-table-wrap table tbody tr td:nth-child(2) {
            border-right: 2px solid #f3f4f6;
        }
        .analysis-table-wrap table thead th:nth-child(2) {
            border-right: 2px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 h-screen overflow-hidden flex font-medium">

    <div id="loadingOverlay">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-pink-500 border-opacity-20 border-t-pink-500 mb-8 mx-auto"></div>
            <p class="text-pink-600 font-bold text-xl tracking-tight">ë°ì´í„° ë™ê¸°í™” ì¤‘...</p>
        </div>
    </div>

    <div id="msgBox" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[200] bg-slate-900 text-white px-8 py-4 rounded-2xl shadow-2xl flex items-center gap-4 border border-white/10">
        <div id="msgIcon" class="text-pink-500"><i class="fas fa-info-circle"></i></div>
        <p id="msgText" class="text-sm font-bold"></p>
    </div>

    <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 z-[1000] w-64 bg-white border-r border-gray-100 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col shadow-sm">
        <div class="p-6 border-b border-gray-100 flex items-center gap-3">
            <div class="w-10 h-10 rounded-2xl bg-gradient-to-tr from-pink-400 to-rose-400 flex items-center justify-center text-white font-bold shadow-lg shadow-pink-100 text-xl">ëš </div>
            <div><h1 class="text-lg font-bold text-gray-800 tracking-tight">ëš ì¹´ë¡± ê¸¸ë“œ í˜„í™©</h1><p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest leading-none mt-1">PUBLIC VIEW</p></div>
            <button id="closeSidebar" class="lg:hidden ml-auto text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        <nav class="p-4 space-y-2 flex-1 overflow-y-auto no-scrollbar">
            <button onclick="router('dashboard')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="dashboard"><i class="fas fa-columns w-5 text-center"></i><span>ëŒ€ì‹œë³´ë“œ</span></button>
            <button onclick="router('members')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="members"><i class="fas fa-users w-5 text-center"></i><span>ê¸¸ë“œì› ëª©ë¡</span></button>
            <button onclick="router('analysis')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="analysis"><i class="fas fa-chart-line w-5 text-center"></i><span>ìˆ˜ë¡œ ì ìˆ˜ ë¶„ì„</span></button>
            <button onclick="router('bail')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="bail"><i class="fas fa-gem w-5 text-center"></i><span>ë³´ì„ê¸ˆ í˜„í™©</span></button>
            <button onclick="router('penalty')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="penalty"><i class="fas fa-exclamation-triangle w-5 text-center"></i><span>ë²Œì  í˜„í™©</span></button>
        </nav>
        <div class="p-4 border-t border-gray-100 bg-gray-50/50 text-center font-bold"><p class="text-[10px] text-green-500 uppercase tracking-widest"><i class="fas fa-cloud mr-1 animate-pulse"></i> Database Connected</p></div>
    </aside>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black/10 z-[990] hidden lg:hidden"></div>

    <main class="flex-1 flex flex-col overflow-hidden bg-gray-50 relative z-0">
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4 lg:px-8 shrink-0 z-10 shadow-sm relative">
            <div class="flex items-center gap-2 lg:gap-4"><button id="openSidebar" class="p-2 lg:hidden rounded-lg hover:bg-gray-100 text-gray-600"><i class="fas fa-bars text-xl"></i></button><h2 id="pageTitle" class="text-lg lg:text-xl font-bold text-gray-800 tracking-tight">ëŒ€ì‹œë³´ë“œ</h2></div>
            <div class="flex items-center gap-3 lg:gap-4">
                <div class="px-3 lg:px-4 py-1.5 bg-pink-50 text-pink-600 rounded-full text-[10px] lg:text-[11px] font-bold border border-pink-100 shadow-sm hidden sm:block">
                    âœ¨ <span id="anniversaryLabel">ë¡œë”© ì¤‘...</span>
                </div>
                <div class="px-3 lg:px-4 py-1.5 bg-slate-50 text-slate-600 rounded-full text-[10px] lg:text-[11px] font-bold border border-slate-100 shadow-sm flex items-center gap-2">
                    <span>ğŸ‘¥</span> <span id="totalMembersCount">ë¡œë”© ì¤‘...</span>
                </div>
                <button id="refreshBtn" onclick="fetchMembers()" class="w-8 h-8 lg:w-10 lg:h-10 flex items-center justify-center rounded-xl hover:bg-gray-100 text-gray-400 transition-all border border-gray-100 shadow-sm"><i class="fas fa-sync-alt text-xs lg:text-base"></i></button>
            </div>
        </header>
        <div id="contentArea" class="flex-1 overflow-y-auto p-3 lg:p-6 relative bg-gray-50 flex flex-col min-h-0"></div>
    </main>

    <!-- Event Detail Modal (read-only) -->
    <div id="eventDetailModal" class="fixed inset-0 z-[2000] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in font-bold p-4">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-sm p-8 lg:p-10 border border-gray-50 relative flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-5 lg:mb-6 shrink-0">
                <h3 id="eventDetailDate" class="text-xl lg:text-2xl font-black text-slate-800 tracking-tighter">Date</h3>
                <button onclick="closeModal('eventDetailModal')" class="text-gray-400 hover:text-gray-600 text-lg lg:text-xl"><i class="fas fa-times"></i></button>
            </div>
            <div id="eventListForDate" class="flex flex-col gap-2 overflow-y-auto no-scrollbar max-h-[60vh]">
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_SHEET_URL = "https://docs.google.com/spreadsheets/d/19V1FFMz9M3gQof6T89nwLSGHEK_OriOint2adLINlY0/edit?gid=1890518105#gid=1890518105";
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxgazT4PO4EQSjC0LS5GMUg27FHkrt9HbLjbW4vKcKmeCBmztpjhtKwLH92ib4boiUYBw/exec";
        const GUILD_START_DATE = new Date('2020-03-17');
        const MAPLE_JOBS = ["íˆì–´ë¡œ", "ë‹¤í¬ë‚˜ì´íŠ¸", "íŒ”ë¼ë”˜", "ë¶ˆë…", "ì¬ì½œ", "ë¹„ìˆ", "ë³´ìš°ë§ˆìŠ¤í„°", "ì‹ ê¶", "íŒ¨ìŠ¤íŒŒì¸ë”","ë‚˜ì´íŠ¸ë¡œë“œ", "ì„€ë„ì–´", "ë“€ì–¼ë¸”ë ˆì´ë“œ", "ìº¡í‹´", "ë°”ì´í¼", "ìºë…¼ë§ˆìŠ¤í„°","ë¯¸í•˜ì¼", "ì†Œìš¸ë§ˆìŠ¤í„°", "í”Œë ˆì„ìœ„ìë“œ", "ìœˆë“œë¸Œë ˆì´ì»¤", "ë‚˜ì´íŠ¸ì›Œì»¤", "ìŠ¤íŠ¸ë¼ì´ì»¤","ì•„ë€", "ì—ë°˜", "ë£¨ë¯¸ë„ˆìŠ¤", "ë©”ë¥´ì„¸ë°ìŠ¤", "íŒ¬í…€", "ì€ì›”","ë°ëª¬ ìŠ¬ë ˆì´ì–´", "ë°ëª¬ ì–´ë²¤ì ¸", "ë¸”ë˜ìŠ¤í„°", "ë°°í‹€ë©”ì´ì§€", "ì™€ì¼ë“œí—Œí„°", "ë©”ì¹´ë‹‰", "ì œë…¼","ì¹´ì´ì €", "ì¹´ì¸", "ì¹´ë°ë‚˜", "ì—”ì ¤ë¦­ë²„ìŠ¤í„°","ë¼ë¼", "í˜¸ì˜", "ì•„ë¸", "ì¼ë¦¬ì›€", "ì•„í¬", "ì¹¼ë¦¬","ì œë¡œ", "í‚¤ë„¤ì‹œìŠ¤", "ë Œ"];
        const baseRanks = ['ë§ˆì¹´ë¡±', 'ë‹¤ì¿ ì•„ì¦ˆ'];
        const initialGuildRanks = {
            'ëš ì¹´ë¡±': [...baseRanks, 'í¬ë¼ìš´', 'íŒŒë¥´í˜', 'í‹°ë¼ë¯¸ìŠˆ', 'í¬ë¡œì¹¸ìŠˆ', 'ë¡¤ì¼€ì´í¬', 'íŒ¬ì¼€ì´í¬', 'ì™€í”Œ'],
            'ëš±ì¹´ë¡±': [...baseRanks, 'ëš ì¼€ì´í¬', 'ëš ë¸Œë ˆë“œ', 'ìˆ˜í”Œë ˆ', 'ëš ìŠ¤ì½˜', 'ë°˜ì£½', 'ë°˜ì£½(íœ´ë©´)', 'ì•„ì¸ìŠˆí˜ë„ˆ'],
            'ë°¤ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆí˜ë„ˆ', 'ë°˜ì£½', 'ë°˜ì£½(íœ´ë©´)'],
            'ë³„ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆí˜ë„ˆ', 'ë°˜ì£½', 'ë°˜ì£½(íœ´ë©´)'],
            'ë‹¬ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆí˜ë„ˆ', 'ë°˜ì£½', 'ë°˜ì£½(íœ´ë©´)'],
            'ê¿€ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆí˜ë„ˆ', 'ë°˜ì£½', 'ë°˜ì£½(íœ´ë©´)']
        };
        const ITEMS_PER_PAGE = 17;

        let jobChartInstance = null;
        let analysisChartInstance = null;

        const appState = {
            activeTab: 'dashboard',
            guilds: [
                { id: 'ddun', name: 'ëš ì¹´ë¡±', type: 'ë©”ì¸ 1ê¸°', color: '#f472b6', icon: 'fa-crown', max: 200 },
                { id: 'ddung', name: 'ëš±ì¹´ë¡±', type: 'ë©”ì¸ 2ê¸°', color: '#fb7185', icon: 'fa-heart', max: 200 },
                { id: 'bam', name: 'ë°¤ì¹´ë¡±', type: 'ë¶€ìº 1ê¸°', color: '#6366f1', icon: 'fa-moon', max: 200 },
                { id: 'byeol', name: 'ë³„ì¹´ë¡±', type: 'ë¶€ìº 2ê¸°', color: '#facc15', icon: 'fa-star', max: 200 },
                { id: 'dal', name: 'ë‹¬ì¹´ë¡±', type: 'ë¶€ìº 3ê¸°', color: '#60a5fa', icon: 'fa-sun', max: 200 },
                { id: 'kkul', name: 'ê¿€ì¹´ë¡±', type: 'ë¶€ìº 4ê¸°', color: '#fbbf24', icon: 'fa-cube', max: 200 },
            ],
            members: [], history: [], bailHistory: [], suroHeaders: [],
            events: [],
            penaltyHistory: [],
            filters: { guild: 'all', search: '', sortField: 'name', sortOrder: 'asc' },
            analysisFilters: { sortField: 'avg', sortOrder: 'desc', search: '' },
            analysisGuild: 'ëš ì¹´ë¡±',
            calendarView: { year: new Date().getFullYear(), month: new Date().getMonth() },
            scriptUrl: APPS_SCRIPT_URL,
            sheetUrl: DEFAULT_SHEET_URL,
            guildRanks: initialGuildRanks,
            currentSelectedDate: null,
            pagination: { members: 1, analysis: 1 } 
        };

        window.showMsg = (text, type = 'info') => {
            const box = document.getElementById('msgBox'); if(!box) return;
            document.getElementById('msgText').innerText = text;
            box.classList.add('show'); setTimeout(() => box.classList.remove('show'), 3500);
        };
        window.showLoading = (show) => { document.getElementById('loadingOverlay')?.classList.toggle('force-hide', !show); };
        
        window.getAnniversaryInfo = () => {
            const now = new Date(); const diff = now - GUILD_START_DATE;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const years = Math.floor(days / 365);
            const remainingDays = days % 365;
            return { totalDays: days, years, remainingDays };
        };
        
        window.updateAnniversaryLabel = () => {
            const anniv = window.getAnniversaryInfo();
            const el = document.getElementById('anniversaryLabel');
            if (el) el.innerText = `ëš ì¹´ë¡±ì´ ìƒì„±ëœ ì§€ ${anniv.totalDays}ì¼ (${anniv.years}ë…„ ${anniv.remainingDays}ì¼)`;
        };

        window.calculateTotalSuro = (guildName) => {
            if (!appState.suroHeaders || appState.suroHeaders.length === 0) return 0;
            const lastHeader = appState.suroHeaders[appState.suroHeaders.length - 1];
            return appState.members
                .filter(m => (m.guild || '').trim() === guildName.trim())
                .reduce((s, m) => s + (Math.round(Number(m.suro?.[lastHeader])) || 0), 0);
        };

        window.getAdminBailStats = () => {
            const stats = {};
            appState.bailHistory.forEach(h => { const amount = parseInt(h.amount) || 0; stats[h.receiver] = (stats[h.receiver] || 0) + amount; });
            return Object.entries(stats).sort((a,b) => a[0].localeCompare(b[0], 'ko'));
        };

        function smartCompare(a, b, field, order) {
            let valA = a[field]; let valB = b[field];
            if (field === 'mainInfo') {
                valA = a.isMain ? a.name : (a.mainCharName || "");
                valB = b.isMain ? b.name : (b.mainCharName || "");
            }
            if (valA === valB) return 0;
            const numA = parseFloat(valA); const numB = parseFloat(valB);
            if (!isNaN(numA) && !isNaN(numB)) { return order === 'asc' ? numA - numB : numB - numA; }
            const strA = String(valA || ""); const strB = String(valB || "");
            const res = strA < strB ? -1 : 1;
            return order === 'asc' ? res : -res;
        }

        window.getNicknameIcon = (role) => {
            if (role === 'ë§ˆì¹´ë¡±') return '<i class="fas fa-crown text-blue-500 mr-2 shadow-sm"></i>';
            if (role === 'ë‹¤ì¿ ì•„ì¦ˆ') return '<i class="fas fa-crown text-pink-500 mr-2 shadow-sm"></i>';
            return '<span class="w-3 h-3 rounded-full bg-gray-200 mr-2 inline-block"></span>';
        };

        function formatRankWithSuffix(rank) {
            if (!rank) return '-';
            const special = ['í¬ë¼ìš´', 'íŒŒë¥´í˜', 'í‹°ë¼ë¯¸ìŠˆ', 'í¬ë¡œì¹¸ìŠˆ'];
            if (special.includes(rank)) return `${rank} <span class="text-[8.5px] text-blue-500 font-bold tracking-tighter">(ì•„ì¸ìŠˆí˜ë„ˆ)</span>`;
            return rank;
        }

        window.getSuroPeriodHeader = (dateObj) => { 
            const now = dateObj || new Date(); 
            const day = now.getDay(); 
            let daysSinceWed = day - 3; 
            if (daysSinceWed < 0) daysSinceWed += 7; 
            const endDate = new Date(now); 
            endDate.setDate(now.getDate() - daysSinceWed); 
            const startDate = new Date(endDate); 
            startDate.setDate(endDate.getDate() - 6); 
            const f = (d) => { 
                const yy = d.getFullYear().toString().slice(-2);
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                return `${yy}-${mm}-${dd}`;
            };
            return `${f(startDate)}(ëª©) ~ ${f(endDate)}(ìˆ˜) ìˆ˜ë¡œ ì ìˆ˜`; 
        };

        window.fetchMembers = async () => {
            window.showLoading(true);
            try {
                const targetUrl = appState.scriptUrl + "?t=" + new Date().getTime();
                const response = await fetch(targetUrl, { redirect: 'follow' }); 
                
                if (!response.ok) {
                    throw new Error(`HTTP ì—ëŸ¬ ë°œìƒ! ìƒíƒœì½”ë“œ: ${response.status}`);
                }
                
                const text = await response.text();
                let json;
                try {
                    json = JSON.parse(text);
                } catch(e) {
                    throw new Error("ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (CORS ë˜ëŠ” ê¶Œí•œ ë¬¸ì œ). ì•±ìŠ¤í¬ë¦½íŠ¸ ë°°í¬ ì‹œ 'ëª¨ë“  ì‚¬ìš©ì'ë¡œ ì„¤ì •í–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
                }

                if (json.status === "success") {
                    appState.members = (json.data.members || []).map(m => ({...m, id: String(m.id)})).filter(m => m.name && m.name.trim() !== "");
                    appState.history = json.data.history || [];
                    appState.suroHeaders = json.data.suroHeaders || [];
                    appState.bailHistory = json.data.bailHistory || [];
                    
                    appState.events = (json.data.events || []).map(e => ({
                        id: e.id,
                        date: (e.date || '').split('T')[0].trim(),
                        title: e.title,
                        content: e.content
                    }));
                    
                    appState.penaltyHistory = json.data.penaltyHistory || [];
                    
                    const countEl = document.getElementById('totalMembersCount');
                    if (countEl) {
                        const counts = {};
                        appState.guilds.forEach(g => counts[g.name] = 0);
                        appState.members.forEach(m => {
                            if (counts[m.guild] !== undefined) counts[m.guild]++;
                        });
                        
                        const aliases = { 'ëš ì¹´ë¡±': 'ëš ', 'ëš±ì¹´ë¡±': 'ëš±', 'ë°¤ì¹´ë¡±': 'ë°¤', 'ë³„ì¹´ë¡±': 'ë³„', 'ë‹¬ì¹´ë¡±': 'ë‹¬', 'ê¿€ì¹´ë¡±': 'ê¿€' };
                        const text = appState.guilds.map(g => {
                            const name = aliases[g.name] || g.name.substring(0, 1);
                            return `${name}:${counts[g.name]}`;
                        }).join(' ');
                        
                        countEl.innerText = text;
                    }
                    window.updateAnniversaryLabel();
                } else {
                    window.showMsg("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", "error");
                }
            } catch (e) { 
                console.error("Fetch Error:", e); 
                alert("ğŸš¨ ì„œë²„ í†µì‹  ì‹¤íŒ¨ (Failed to fetch)\n\nêµ¬ê¸€ ì•±ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ë¬¸ì œì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.\nì•±ìŠ¤í¬ë¦½íŠ¸ [ìƒˆ ë°°í¬] ì‹œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë°˜ë“œì‹œ [ëª¨ë“  ì‚¬ìš©ì]ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.");
            } finally {
                window.showLoading(false);
                window.router(appState.activeTab);
            }
        };

        window.router = (tab) => {
            appState.activeTab = tab;
            const content = document.getElementById('contentArea'); if(!content) return;
            content.innerHTML = '';
            document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.target === tab));
            const titles = { dashboard: 'ê¸¸ë“œ í˜„í™©íŒ', members: 'ê¸¸ë“œì› ëª©ë¡', analysis: 'ìˆ˜ë¡œ ë¶„ì„', bail: 'ë³´ì„ê¸ˆ í˜„í™©', penalty: 'ë²Œì  í˜„í™©' };
            document.getElementById('pageTitle').innerText = titles[tab] || '';
            if (tab === 'dashboard') window.renderDashboard(content);
            else if (tab === 'members') window.renderMembers(content);
            else if (tab === 'analysis') window.renderAnalysis(content, appState.analysisGuild);
            else if (tab === 'bail') window.renderBail(content);
            else if (tab === 'penalty') window.renderPenalty(content);
        };

        // --- DASHBOARD ---
        window.renderDashboard = (container) => {
            const ddunT = window.calculateTotalSuro('ëš ì¹´ë¡±'); 
            const ddungT = window.calculateTotalSuro('ëš±ì¹´ë¡±');
            
            container.innerHTML = `
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8 fade-in shrink-0">
                <div class="flex flex-col gap-6">
                    <div class="flex gap-6 h-40">
                        <div onclick="router('analysis'); renderAnalysis(document.getElementById('contentArea'), 'ëš ì¹´ë¡±')" class="flex-1 bg-gradient-to-br from-pink-500 to-rose-500 rounded-[2.5rem] p-8 shadow-lg text-white cursor-pointer hover:scale-[1.02] transition-transform relative overflow-hidden flex flex-col justify-center border-none">
                            <div class="absolute top-0 right-0 p-4 opacity-20 text-5xl"><i class="fas fa-crown"></i></div>
                            <h3 class="text-sm font-bold opacity-80 uppercase tracking-widest text-center">ëš ì¹´ë¡± ìˆ˜ë¡œ ì´ì </h3>
                            <p class="text-3xl font-black tracking-tighter text-center">${ddunT.toLocaleString()}</p>
                        </div>
                        <div onclick="router('analysis'); renderAnalysis(document.getElementById('contentArea'), 'ëš±ì¹´ë¡±')" class="flex-1 bg-white border border-gray-100 rounded-[2.5rem] p-8 shadow-sm text-gray-800 cursor-pointer hover:border-pink-200 transition-all flex flex-col justify-center relative overflow-hidden">
                            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest text-center">ëš±ì¹´ë¡± ìˆ˜ë¡œ ì´ì </h3>
                            <p class="text-3xl font-black tracking-tighter text-pink-500 text-center">${ddungT.toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm flex flex-col">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">ğŸ“…</span>
                                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Guild Calendar</h3>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-2 bg-gray-50 px-3 py-1.5 rounded-2xl border border-gray-100">
                                    <button onclick="moveMonth(-1)" class="w-6 h-6 flex items-center justify-center rounded-lg hover:bg-white hover:text-pink-500 transition-all text-gray-400"><i class="fas fa-chevron-left text-[10px]"></i></button>
                                    <span class="text-[11px] font-bold text-gray-600 w-16 text-center">${appState.calendarView.year}.${String(appState.calendarView.month + 1).padStart(2, '0')}</span>
                                    <button onclick="moveMonth(1)" class="w-6 h-6 flex items-center justify-center rounded-lg hover:bg-white hover:text-pink-500 transition-all text-gray-400"><i class="fas fa-chevron-right text-[10px]"></i></button>
                                </div>
                            </div>
                        </div>
                        ${window.renderCalendar()}
                    </div>
                </div>
                <div class="flex flex-col gap-8 h-full">
                    <div class="bg-white p-10 rounded-[3rem] shadow-sm border border-gray-100 flex flex-col min-h-[300px] overflow-hidden shrink-0">
                        <div class="flex justify-between items-center mb-4 shrink-0">
                            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest">ì§ì—… ë¶„í¬ë„</h3>
                            <select onchange="window.updateJobChart(this.value)" class="bg-gray-50 rounded-xl px-3 py-1.5 text-xs font-bold outline-none cursor-pointer hover:bg-gray-100">
                                <option value="all">ì „ì²´</option>${appState.guilds.map(g => `<option value="${g.name}">${g.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex-1 overflow-y-auto no-scrollbar relative">
                            <div id="jobChartContainer" style="min-height: 250px;"><canvas id="jobChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 fade-in shrink-0">
                ${appState.guilds.map(g => { 
                    const count = appState.members.filter(m => m.guild === g.name).length; 
                    const pct = Math.min((count / g.max) * 100, 100); 
                    return `<div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm hover:shadow-xl transition-all cursor-pointer group" onclick="filterByGuild('${g.name}')"><div class="flex justify-between items-start mb-6"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-gray-50 rounded-2xl flex items-center justify-center text-gray-400 group-hover:bg-pink-50 group-hover:text-pink-500 transition-colors"><i class="fas ${g.icon}"></i></div><div><span class="block font-bold text-lg text-gray-800 group-hover:text-pink-500">${g.name}</span><span class="text-[10px] text-gray-400 font-bold">${g.type}</span></div></div></div><div class="w-full bg-gray-50 rounded-full h-1.5 overflow-hidden"><div class="h-full bg-pink-500 transition-all duration-1000" style="width:${pct}%"></div></div><p class="text-[10px] text-gray-400 font-bold mt-2 text-right">${count} / ${g.max}</p></div>`; 
                }).join('')}
            </div>`;
            setTimeout(() => window.updateJobChart('all'), 0);
        };

        window.moveMonth = (delta) => {
            let newMonth = appState.calendarView.month + delta;
            let newYear = appState.calendarView.year;
            if (newMonth < 0) { newMonth = 11; newYear--; }
            else if (newMonth > 11) { newMonth = 0; newYear++; }
            appState.calendarView.month = newMonth;
            appState.calendarView.year = newYear;
            window.router('dashboard');
        };

        window.renderCalendar = () => { 
            const year = appState.calendarView.year, month = appState.calendarView.month; 
            const first = new Date(year, month, 1).getDay();
            const last = new Date(year, month + 1, 0).getDate(); 
            const prevLast = new Date(year, month, 0).getDate();
            const today = new Date();
            
            let html = `<div class="calendar-grid"><div class="calendar-head text-red-400">ì¼</div><div class="calendar-head">ì›”</div><div class="calendar-head">í™”</div><div class="calendar-head">ìˆ˜</div><div class="calendar-head text-pink-500">ëª©</div><div class="calendar-head">ê¸ˆ</div><div class="calendar-head text-blue-400">í† </div>`; 
            
            for(let i=first; i>0; i--) {
                html += `<div class="calendar-day not-current"><span>${prevLast - i + 1}</span></div>`;
            }

            for(let d=1; d<=last; d++) { 
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayEvents = appState.events.filter(e => {
                    const eDate = (e.date || '').split('T')[0].trim();
                    return eDate === dateStr;
                });
                
                const isToday = today.getFullYear()===year && today.getMonth()===month && today.getDate()===d;
                const isThursday = new Date(year, month, d).getDay() === 4;

                let cls = "calendar-day text-gray-600";
                if(isThursday) cls += " thursday";
                if(isToday) cls += " today";
                
                let eventHtml = '';
                if(dayEvents.length > 0) {
                    eventHtml += `<div class="event-dot"></div>`;
                    dayEvents.slice(0, 2).forEach(e => {
                        eventHtml += `<div class="event-snippet" title="${e.title}">${e.title}</div>`;
                    });
                    if (dayEvents.length > 2) eventHtml += `<div class="text-[9px] text-pink-400 mt-0.5 leading-none font-bold">+${dayEvents.length - 2}</div>`;
                }
                html += `<div class="${cls}" onclick="window.showEventDetail('${dateStr}')"><span>${d}</span>${eventHtml}</div>`; 
            } 
            
            const totalCells = first + last;
            const extraCells = (7 - (totalCells % 7)) % 7;
            for(let i=1; i<=extraCells; i++) {
                html += `<div class="calendar-day not-current"><span>${i}</span></div>`;
            }

            return html + `</div>`; 
        };

        window.showEventDetail = (dateStr) => {
            appState.currentSelectedDate = dateStr;
            const modal = document.getElementById('eventDetailModal');
            document.getElementById('eventDetailDate').innerText = dateStr;
            
            const dayEvents = appState.events.filter(e => e.date === dateStr);
            const listContainer = document.getElementById('eventListForDate');
            listContainer.innerHTML = '';
            
            if (dayEvents.length > 0) {
                dayEvents.forEach(e => {
                    const item = document.createElement('div');
                    item.className = 'p-4 bg-gray-50 border border-gray-100 rounded-xl text-xs font-bold text-gray-600 space-y-1';
                    item.innerHTML = `<div class="text-pink-600 text-sm">${e.title}</div>${e.content ? `<div class="text-gray-400 text-[11px] whitespace-pre-wrap">${e.content}</div>` : ''}`;
                    listContainer.appendChild(item);
                });
            } else {
                listContainer.innerHTML = `<p class="text-xs text-gray-400 text-center py-4">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }

            modal.classList.remove('hidden');
        };

        window.closeModal = (id) => { document.getElementById(id)?.classList.add('hidden'); };

        window.changePage = (type, delta) => {
            appState.pagination[type] += delta;
            if (type === 'members') window.updateMemberTable();
        };

        window.setAnalysisSearch = (val) => {
            appState.analysisFilters.search = val;
            window.renderAnalysis(document.getElementById('contentArea'), appState.analysisGuild);
        };

        // --- ANALYSIS (100% preserved) ---
        window.renderAnalysis = (container, gName) => {
            appState.analysisGuild = gName;
            
            const guildTargets = appState.members.filter(m => m.guild === gName);
            const searchToken = (appState.analysisFilters.search || '').toLowerCase().trim();
            const displayTargets = searchToken ? guildTargets.filter(m => m.name.toLowerCase().includes(searchToken)) : guildTargets;
            
            const getWedStr = (h) => {
                if (!h) return '';
                const p = h.split('~');
                return p.length > 1 ? p[1].replace('ìˆ˜ë¡œ ì ìˆ˜', '').trim() : h.trim();
            };
            const getShortWedStr = (h) => {
                const str = getWedStr(h);
                const p = str.split('-');
                return p.length >= 3 ? p[1] + '-' + p[2].substring(0,2) : str;
            };

            const recentHeaders = [...appState.suroHeaders]; 
            const currentHeader = recentHeaders.length > 0 ? recentHeaders[recentHeaders.length - 1] : null;

            const displayTotal = currentHeader ? guildTargets.reduce((s, m) => s + (Math.round(Number(m.suro?.[currentHeader])) || 0), 0) : 0;
            const zeroPointMembers = currentHeader ? guildTargets.filter(m => (Math.round(Number(m.suro?.[currentHeader])) || 0) === 0) : [];
            
            const processedList = displayTargets.map(m => {
                const scores = recentHeaders.map(h => Math.round(Number(m.suro?.[h])) || 0);
                const validScores = scores.filter(s => s > 0);
                const avg = validScores.length > 0 ? Math.round(validScores.reduce((a, b) => a + b, 0) / validScores.length) : 0;
                return { ...m, avg: avg, recentScores: scores };
            });

            let topScores = [];
            let scoreIncreases = [];
            let pctIncreases = [];
            let avgIncreases = [];

            if (recentHeaders.length >= 2 && currentHeader) {
                const prevHeader = recentHeaders[recentHeaders.length - 2];
                guildTargets.forEach(m => {
                    const currScore = Math.round(Number(m.suro?.[currentHeader])) || 0;
                    const prevScore = Math.round(Number(m.suro?.[prevHeader])) || 0;
                    
                    const pastScores = recentHeaders.slice(0, -1).map(h => Math.round(Number(m.suro?.[h])) || 0).filter(s => s > 0);
                    const pastAvg = pastScores.length > 0 ? Math.round(pastScores.reduce((a,b)=>a+b,0) / pastScores.length) : 0;

                    if (currScore > 0) {
                        topScores.push({ name: m.name, val: currScore, role: m.role });
                    }

                    if (prevScore > 0 && currScore > prevScore) {
                        const increase = currScore - prevScore;
                        const increasePct = (increase / prevScore) * 100;
                        scoreIncreases.push({ name: m.name, val: increase, role: m.role });
                        pctIncreases.push({ name: m.name, val: increasePct, role: m.role });
                    }
                    
                    if (pastAvg > 0 && currScore > pastAvg) {
                        const aboveAvg = currScore - pastAvg;
                        avgIncreases.push({ name: m.name, val: aboveAvg, role: m.role });
                    }
                });
            } else if (currentHeader) {
                guildTargets.forEach(m => {
                    const currScore = Math.round(Number(m.suro?.[currentHeader])) || 0;
                    if (currScore > 0) {
                        topScores.push({ name: m.name, val: currScore, role: m.role });
                    }
                });
            }

            topScores.sort((a,b) => b.val - a.val);
            scoreIncreases.sort((a,b) => b.val - a.val);
            pctIncreases.sort((a,b) => b.val - a.val);
            avgIncreases.sort((a,b) => b.val - a.val);

            const topScoreHighMVP = topScores.slice(0, 3);
            const topScoreMVP = scoreIncreases.slice(0, 3);
            const topPctMVP = pctIncreases.slice(0, 3);
            const topAvgMVP = avgIncreases.slice(0, 3);

            processedList.sort((a, b) => {
                const f = appState.analysisFilters.sortField;
                const o = appState.analysisFilters.sortOrder;
                
                if (f.startsWith('date_')) {
                    const targetHeader = f.replace('date_', '');
                    const headerIdx = recentHeaders.indexOf(targetHeader);
                    const prevHeader = headerIdx > 0 ? recentHeaders[headerIdx - 1] : null;

                    const getIncRate = (m) => {
                        const curr = Math.round(Number(m.suro?.[targetHeader])) || 0;
                        if (!prevHeader) return curr > 0 ? -500 : -1000;
                        const prev = Math.round(Number(m.suro?.[prevHeader])) || 0;
                        if (curr === 0 && prev === 0) return -1000; 
                        if (prev === 0 && curr > 0) return -500; 
                        return ((curr - prev) / prev) * 100;
                    };

                    const rateA = getIncRate(a);
                    const rateB = getIncRate(b);
                    
                    if (rateA === rateB) {
                        const currA = Math.round(Number(a.suro?.[targetHeader])) || 0;
                        const currB = Math.round(Number(b.suro?.[targetHeader])) || 0;
                        return o === 'asc' ? currA - currB : currB - currA;
                    }
                    return o === 'asc' ? rateA - rateB : rateB - rateA;
                }

                if (f === 'avg') return o === 'asc' ? a.avg - b.avg : b.avg - a.avg;
                if (f === 'score') {
                    const vA = Math.round(Number(a.suro?.[currentHeader])) || 0;
                    const vB = Math.round(Number(b.suro?.[currentHeader])) || 0;
                    return o === 'asc' ? vA - vB : vB - vA;
                }
                return smartCompare(a, b, f, o);
            });

            const sortIcon = (f) => appState.analysisFilters.sortField === f ? (appState.analysisFilters.sortOrder === 'asc' ? ' <i class="fas fa-sort-up"></i>' : ' <i class="fas fa-sort-down"></i>') : '';
            const analysisGuildsOptions = ['ëš ì¹´ë¡±', 'ëš±ì¹´ë¡±'];
            
            const renderMvpList = (list, type) => {
                if(list.length === 0) return `<div class="flex items-center justify-center h-full pb-2"><span class="text-[10px] text-gray-400 font-bold">ë°ì´í„° ë¶€ì¡±</span></div>`;
                
                let colorBase = '';
                if(type === 'high') colorBase = 'blue';
                else if(type === 'score') colorBase = 'orange';
                else if(type === 'pct') colorBase = 'emerald';
                else if(type === 'avg') colorBase = 'purple';

                return `<div class="flex flex-col gap-1.5 z-10 w-full mt-2">
                    ${list.map((m, idx) => {
                        let displayVal = '';
                        if(type === 'high') displayVal = Math.round(m.val).toLocaleString();
                        else if(type === 'score') displayVal = '+' + Math.round(m.val).toLocaleString();
                        else if(type === 'pct') displayVal = 'â–²' + m.val.toFixed(1) + '%';
                        else if(type === 'avg') displayVal = '+' + Math.round(m.val).toLocaleString();

                        return `<div class="flex justify-between items-center text-[10px] leading-none bg-white/40 rounded px-1.5 py-1">
                            <div class="flex items-center gap-1.5 overflow-hidden">
                                <span class="font-black text-${colorBase}-500 inline-block w-2.5 text-center">${idx+1}</span>
                                <span class="font-bold text-gray-800 truncate" style="max-width: 60px;" title="${m.name}">${m.name}</span>
                            </div>
                            <span class="font-black text-${colorBase}-600 shrink-0">${displayVal}</span>
                        </div>`;
                    }).join('')}
                </div>`;
            };

            container.innerHTML = `
            <div class="flex flex-col gap-4 fade-in h-full">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 shrink-0">
                    <div class="flex gap-2 overflow-x-auto no-scrollbar shrink-0 w-full sm:w-auto">
                        ${analysisGuildsOptions.map(gNameOption => `<button onclick="window.renderAnalysis(document.getElementById('contentArea'), '${gNameOption}')" class="px-6 py-2.5 rounded-xl text-xs font-bold transition-all shrink-0 ${gNameOption === gName ? 'bg-pink-500 text-white shadow-lg' : 'bg-white text-gray-500 border border-gray-100'}">${gNameOption}</button>`).join('')}
                    </div>
                    <div class="relative w-full sm:w-64 shrink-0">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                        <input type="text" oninput="window.setAnalysisSearch(this.value)" value="${appState.analysisFilters.search || ''}" class="w-full pl-10 pr-4 py-2.5 bg-white border border-gray-100 rounded-xl outline-none text-xs font-bold shadow-sm focus:ring-2 focus:ring-pink-50 transition-all" placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰">
                    </div>
                </div>

                <div class="flex flex-col gap-3 shrink-0">
                    <div class="grid grid-cols-3 gap-3 font-bold">
                        <div class="bg-white py-3 lg:py-4 px-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col justify-center items-center h-full min-h-[80px]">
                            <p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest mb-1.5">ì „ì²´ ì´ì </p>
                            <h4 class="text-base lg:text-xl font-black text-gray-800 tracking-tighter">${displayTotal.toLocaleString()}</h4>
                        </div>
                        <div class="bg-red-50 py-3 lg:py-4 px-4 rounded-2xl border border-red-100 shadow-sm flex flex-col justify-center items-center h-full min-h-[80px]">
                            <p class="text-[9px] text-red-500 font-bold uppercase tracking-widest mb-1.5">ğŸš¨ ë¯¸ì°¸ì—¬</p>
                            <h4 class="text-base lg:text-xl font-black text-red-600 tracking-tighter">${zeroPointMembers.length}ëª…</h4>
                        </div>
                        <div class="bg-white py-3 lg:py-4 px-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col justify-center items-center h-full min-h-[80px]">
                            <p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest mb-1.5">ìµœê·¼ ë°ì´í„° ì£¼ì°¨</p>
                            <h4 class="text-xs lg:text-sm font-bold text-gray-700">${currentHeader ? getWedStr(currentHeader) : 'ë°ì´í„° ì—†ìŒ'}</h4>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 font-bold">
                        <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-3.5 rounded-2xl border border-blue-100 shadow-sm flex flex-col relative overflow-hidden h-full min-h-[100px]">
                            <div class="absolute -right-2 -bottom-2 opacity-[0.05] text-6xl text-blue-500"><i class="fas fa-crown"></i></div>
                            <p class="text-[9px] text-blue-600 font-bold uppercase tracking-widest z-10 flex items-center gap-1"><i class="fas fa-star"></i> ì´ë²ˆ ì£¼ ê³ ë“ì  MVP</p>
                            ${renderMvpList(topScoreHighMVP, 'high')}
                        </div>
                        <div class="bg-gradient-to-br from-yellow-50 to-orange-50 p-3.5 rounded-2xl border border-orange-100 shadow-sm flex flex-col relative overflow-hidden h-full min-h-[100px]">
                            <div class="absolute -right-2 -bottom-2 opacity-[0.05] text-6xl text-orange-500"><i class="fas fa-trophy"></i></div>
                            <p class="text-[9px] text-orange-600 font-bold uppercase tracking-widest z-10 flex items-center gap-1"><i class="fas fa-arrow-trend-up"></i> ì£¼ê°„ ì ìˆ˜ ë–¡ìƒ MVP</p>
                            ${renderMvpList(topScoreMVP, 'score')}
                        </div>
                        <div class="bg-gradient-to-br from-emerald-50 to-teal-50 p-3.5 rounded-2xl border border-emerald-100 shadow-sm flex flex-col relative overflow-hidden h-full min-h-[100px]">
                            <div class="absolute -right-2 -bottom-2 opacity-[0.05] text-6xl text-emerald-500"><i class="fas fa-chart-line"></i></div>
                            <p class="text-[9px] text-emerald-600 font-bold uppercase tracking-widest z-10 flex items-center gap-1"><i class="fas fa-percent"></i> ì£¼ê°„ ìƒìŠ¹ë¥  MVP</p>
                            ${renderMvpList(topPctMVP, 'pct')}
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-fuchsia-50 p-3.5 rounded-2xl border border-purple-100 shadow-sm flex flex-col relative overflow-hidden h-full min-h-[100px]">
                            <div class="absolute -right-2 -bottom-2 opacity-[0.05] text-6xl text-purple-500"><i class="fas fa-bolt"></i></div>
                            <p class="text-[9px] text-purple-600 font-bold uppercase tracking-widest z-10 flex items-center gap-1"><i class="fas fa-balance-scale"></i> ì£¼ê°„ í‰ê· ëŒ€ë¹„ ë–¡ìƒ</p>
                            ${renderMvpList(topAvgMVP, 'avg')}
                        </div>
                    </div>
                </div>

                <div class="flex flex-col lg:flex-row gap-5 flex-1 min-h-[400px] lg:min-h-0">
                    <div class="w-full lg:w-[30%] bg-white p-5 rounded-2xl border border-gray-100 shadow-sm flex flex-col overflow-hidden shrink-0 lg:h-full">
                        <h3 class="text-xs font-bold text-gray-400 mb-4 uppercase tracking-widest">ì£¼ê°„ ì´ì  ì¶”ì´</h3>
                        <div class="flex-1 w-full min-h-[150px] relative">
                            <canvas id="analysisChart"></canvas>
                        </div>
                    </div>

                    <div class="w-full lg:w-[70%] bg-white rounded-2xl border border-gray-100 shadow-sm flex flex-col overflow-hidden shrink-0 lg:h-full relative">
                        <div class="p-4 border-b border-gray-50 flex justify-between items-center shrink-0 bg-white relative z-40">
                            <h3 class="text-xs font-bold text-gray-800 uppercase tracking-widest">ì „ì²´ ë°ì´í„° (ëˆ„ì )</h3>
                        </div>
                        <div id="analysisTableWrapper" class="analysis-table-wrap flex-1 overflow-auto bg-white scroll-smooth relative">
                            <table class="w-full text-left text-xs whitespace-nowrap">
                                <thead class="text-[10px] text-gray-500 uppercase bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th class="p-3 text-center min-w-[50px]">RANK</th>
                                        <th class="p-3 sortable cursor-pointer hover:bg-gray-200 min-w-[140px]" onclick="window.setAnalysisSort('name')">ìºë¦­í„°ëª…${sortIcon('name')}</th>
                                        <th class="p-3 text-center sortable bg-pink-50 text-pink-600 cursor-pointer min-w-[110px]" onclick="window.setAnalysisSort('avg')">í‰ê·  (ì°¸ì—¬)${sortIcon('avg')}</th>
                                        ${recentHeaders.map((h, idx) => {
                                            const displayStr = getWedStr(h);
                                            return `<th class="p-3 min-w-[100px] text-right font-medium cursor-pointer hover:bg-gray-200 transition-colors select-none" onclick="window.setAnalysisSort('date_${h}')" title="í´ë¦­í•˜ì—¬ ìƒìŠ¹ë¥  ìˆœìœ¼ë¡œ ì •ë ¬">${displayStr}${sortIcon('date_'+h)}</th>`;
                                        }).join('')}
                                    </tr>
                                </thead>
                                <tbody class="font-bold text-gray-700">
                                    ${processedList.map((m, i) => {
                                        const globalIndex = i + 1;
                                        return `
                                        <tr class="group h-11 hover:bg-gray-50 transition-colors border-b border-gray-50">
                                            <td class="p-3 text-center text-gray-400 group-hover:bg-gray-50 border-r border-gray-50">${globalIndex}</td>
                                            <td class="p-3 text-gray-800 group-hover:bg-gray-50 border-r border-gray-50">
                                                <div class="flex items-center leading-none overflow-hidden text-ellipsis">
                                                    ${window.getNicknameIcon(m.role)}<span class="truncate">${m.name}</span>
                                                </div>
                                            </td>
                                            <td class="p-3 text-center text-pink-600 bg-pink-50/30 group-hover:bg-pink-100 border-r border-pink-50">${m.avg.toLocaleString()}</td>
                                            ${m.recentScores.map((s, scoreIdx) => {
                                                let diffHtml = '';
                                                let prevScore = 0;
                                                
                                                if (scoreIdx > 0) {
                                                    prevScore = m.recentScores[scoreIdx - 1];
                                                }

                                                if (s > 0 || (s === 0 && prevScore > 0)) {
                                                    if (prevScore > 0) {
                                                        const diffPct = ((s - prevScore) / prevScore * 100);
                                                        if (s > prevScore) {
                                                            diffHtml = `<span class="text-[9px] text-red-500 font-bold tracking-tighter block mt-0.5">â–² ${diffPct.toFixed(1)}%</span>`;
                                                        } else if (s < prevScore) {
                                                            diffHtml = `<span class="text-[9px] text-blue-500 font-bold tracking-tighter block mt-0.5">â–¼ ${Math.abs(diffPct).toFixed(1)}%</span>`;
                                                        } else {
                                                            diffHtml = `<span class="text-[9px] text-gray-400 font-bold tracking-tighter block mt-0.5">- 0.0%</span>`;
                                                        }
                                                    } else if (s > 0) {
                                                        diffHtml = `<span class="text-[9px] text-red-500 font-bold tracking-tighter block mt-0.5">â–² NEW</span>`;
                                                    }
                                                }

                                                return `
                                                <td class="p-3 min-w-[100px] text-right font-mono align-middle ${s === 0 ? 'bg-red-50/20 text-red-400 group-hover:bg-red-50/50' : 'bg-white text-gray-700 group-hover:bg-gray-50'} relative z-10">
                                                    <div class="flex flex-col justify-center items-end leading-tight min-h-[28px]">
                                                        <span class="${s > 0 ? 'text-xs' : 'text-gray-400'}">${s > 0 ? s.toLocaleString() : '0'}</span>
                                                        ${diffHtml}
                                                    </div>
                                                </td>
                                                `;
                                            }).join('')}
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>`;

            setTimeout(() => {
                const tableWrapper = document.getElementById('analysisTableWrapper');
                if (tableWrapper) {
                    tableWrapper.scrollLeft = tableWrapper.scrollWidth;
                }
            }, 100);

            const ctx = document.getElementById('analysisChart');
            if(!ctx) return;
            if(analysisChartInstance) analysisChartInstance.destroy();
            analysisChartInstance = new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels: recentHeaders.map(h => getShortWedStr(h)), 
                    datasets: [{ 
                        label: 'ê¸¸ë“œ ì´ì ', 
                        data: recentHeaders.map(h => guildTargets.reduce((s, m) => s + (Math.round(Number(m.suro?.[h])) || 0), 0)), 
                        borderColor: '#ec4899', 
                        borderWidth: 3, 
                        pointRadius: 4, 
                        pointBackgroundColor: '#fff', 
                        tension: 0.4, 
                        fill: true, 
                        backgroundColor: 'rgba(236, 72, 153, 0.05)' 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        y: { display: false }, 
                        x: { grid: { display: false }, ticks: { font: { size: 10, weight: 'bold' } } } 
                    } 
                } 
            });
        };
        
        window.setAnalysisSort = (f) => { 
            if(appState.analysisFilters.sortField === f) {
                appState.analysisFilters.sortOrder = appState.analysisFilters.sortOrder === 'asc' ? 'desc' : 'asc'; 
            } else { 
                appState.analysisFilters.sortField = f; 
                appState.analysisFilters.sortOrder = (f==='score'||f==='rank'||f==='avg'||f.startsWith('date_')) ? 'desc' : 'asc'; 
            } 
            window.renderAnalysis(document.getElementById('contentArea'), appState.analysisGuild); 
        };

        window.updateJobChart = (target) => {
            const ctx = document.getElementById('jobChart'); if(!ctx) return;
            const container = document.getElementById('jobChartContainer');
            
            const targets = target === 'all' ? appState.members : appState.members.filter(m => m.guild === target);
            const counts = {}; targets.forEach(m => { const j = m.class || 'ë¯¸ì„¤ì •'; counts[j] = (counts[j] || 0) + 1; });
            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
            
            const newHeight = Math.max(250, 50 + (sorted.length * 30));
            if(container) container.style.height = newHeight + 'px';

            const jobPalette = [
                '#FF9AA2', '#FFB7B2', '#FFDAC1', '#E2F0CB', '#B5EAD7', '#C7CEEA',
                '#FF6F61', '#6B5B95', '#88B04B', '#F7CAC9', '#92A8D1', '#955251',
                '#B565A7', '#009B77', '#DD4124', '#D65076', '#45B8AC', '#EFC050',
                '#5B5EA6', '#9B2335', '#DFCFBE', '#55B4B0', '#E15D44', '#7FCDCD',
                '#BC243C', '#C3447A', '#98B4D4'
            ];

            const backgroundColors = sorted.map((_, i) => jobPalette[i % jobPalette.length]);

            if(jobChartInstance) jobChartInstance.destroy();
            jobChartInstance = new Chart(ctx, { 
                type: 'bar', 
                data: { 
                    labels: sorted.map(j => j[0]), 
                    datasets: [{ 
                        label: 'ì¸ì›', 
                        data: sorted.map(j => j[1]), 
                        backgroundColor: backgroundColors,
                        borderRadius: 4, 
                        barThickness: 20
                    }] 
                }, 
                options: { 
                    indexAxis: 'y', 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        x: { beginAtZero: true, ticks: { precision: 0 } },
                        y: { ticks: { autoSkip: false, font: { size: 11, weight: 'bold' }, color: '#4b5563' } }
                    } 
                } 
            });
        };

        // --- MEMBERS (Public, read-only, card-based on mobile) ---
        window.handleSearch = (v) => { appState.filters.search = v; appState.pagination.members = 1; window.updateMemberTable(); };
        window.filterByGuild = (g) => { appState.filters.guild = g; appState.pagination.members = 1; if(appState.activeTab === 'members') window.renderMembers(document.getElementById('contentArea')); else window.updateMemberTable(); };
        window.handleSort = (field) => { if(appState.filters.sortField === field) appState.filters.sortOrder = appState.filters.sortOrder === 'asc' ? 'desc' : 'asc'; else { appState.filters.sortField = field; appState.filters.sortOrder = 'asc'; } appState.pagination.members = 1; window.updateMemberTable(); };

        window.renderMembers = (container) => {
            container.innerHTML = `
            <div class="flex flex-col gap-3 fade-in h-full">
                <div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col xl:flex-row items-center gap-4 shrink-0">
                    <div class="flex overflow-x-auto no-scrollbar w-full xl:w-auto gap-2 shrink-0">
                        <button onclick="window.filterByGuild('all')" class="shrink-0 px-4 py-2 rounded-xl text-xs font-bold transition-all ${appState.filters.guild === 'all' ? 'bg-gray-800 text-white shadow-md' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">ì „ì²´</button>
                        ${appState.guilds.map(g => `<button onclick="window.filterByGuild('${g.name}')" class="shrink-0 px-4 py-2 rounded-xl text-xs font-bold transition-all ${appState.filters.guild === g.name ? 'bg-pink-500 text-white shadow-md' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">${g.name}</button>`).join('')}
                    </div>
                    <div class="relative flex-1 w-full">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                        <input type="text" oninput="window.handleSearch(this.value)" value="${appState.filters.search}" class="w-full pl-10 pr-4 py-2.5 bg-gray-50 border border-gray-100 rounded-xl outline-none text-xs font-bold shadow-inner focus:ring-2 focus:ring-pink-50 transition-all" placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰">
                    </div>
                </div>
                <div id="memberTableContainer" class="bg-white rounded-2xl border border-gray-100 overflow-hidden shadow-sm flex-1 min-h-0 flex flex-col"></div>
            </div>`;
            window.updateMemberTable();
        };

        window.updateMemberTable = () => {
            const container = document.getElementById('memberTableContainer'); if(!container) return;
            
            const rawSearchTerm = appState.filters.search.trim();
            const searchTokens = rawSearchTerm.length > 0 
                ? rawSearchTerm.toLowerCase().split(/[\s,]+/).filter(t => t.length > 0)
                : [];

            const filtered = appState.members.filter(m => { 
                const gMatch = appState.filters.guild === 'all' || m.guild === appState.filters.guild; 
                if (searchTokens.length === 0) return gMatch;
                const sMatch = searchTokens.some(token => {
                    return m.name.toLowerCase().includes(token) || 
                           (m.class||'').toLowerCase().includes(token) || 
                           (m.role||'').toLowerCase().includes(token) ||
                           (m.mainCharName || '').toLowerCase().includes(token) || 
                           (m.isMain && m.name.toLowerCase().includes(token)); 
                });
                return gMatch && sMatch; 
            });

            filtered.sort((a, b) => smartCompare(a, b, appState.filters.sortField, appState.filters.sortOrder));
            
            const totalItems = filtered.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            if (appState.pagination.members > totalPages && totalPages > 0) appState.pagination.members = totalPages;
            if (appState.pagination.members < 1) appState.pagination.members = 1;
            
            const pageData = filtered.slice((appState.pagination.members - 1) * ITEMS_PER_PAGE, appState.pagination.members * ITEMS_PER_PAGE);
            const sortIcon = (f) => appState.filters.sortField === f ? (appState.filters.sortOrder === 'asc' ? ' <i class="fas fa-sort-up"></i>' : ' <i class="fas fa-sort-down"></i>') : '';
            
            const isMobile = window.innerWidth < 768;

            let html = '';

            if (isMobile) {
                // --- MOBILE: Card-based layout ---
                html = `<div class="flex-1 overflow-y-auto p-3 space-y-2">`;
                pageData.forEach((m, idx) => {
                    const globalIndex = (appState.pagination.members - 1) * ITEMS_PER_PAGE + idx + 1;
                    const mainName = m.isMain ? m.name : (m.mainCharName || '-');
                    const mainMem = appState.members.find(x => x.name === mainName);
                    const mainRankHtml = mainMem ? formatRankWithSuffix(mainMem.role) : '-';
                    
                    let roleHtml = `<span class="text-[10px]">${m.role}</span>`;
                    if (m.role === 'ì•„ì¸ìŠˆí˜ë„ˆ') {
                        roleHtml = `<span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold text-white tracking-tight shadow-sm" style="background-color: #FF99FF;">${m.role}</span>`;
                    }

                    html += `
                    <div class="member-card">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] text-gray-400 font-bold w-6 text-center">${globalIndex}</span>
                                ${window.getNicknameIcon(m.role)}
                                <span class="font-bold text-sm text-gray-800">${m.name}</span>
                            </div>
                            ${roleHtml}
                        </div>
                        <div class="flex items-center gap-3 text-[11px] text-gray-500">
                            <span class="bg-gray-50 px-2 py-0.5 rounded-lg">${m.guild}</span>
                            <span class="text-gray-300">|</span>
                            <span>${m.class || '-'}</span>
                            <span class="text-gray-300">|</span>
                            <span class="text-gray-400">ë³¸ìº: ${mainName}</span>
                        </div>
                    </div>`;
                });
                html += `</div>`;
            } else {
                // --- DESKTOP: Table layout (read-only, no action column) ---
                html = `<div class="overflow-y-auto flex-1 relative"><table class="w-full text-left min-w-[800px] text-xs whitespace-nowrap"><thead class="bg-gray-50 text-[10px] font-bold text-gray-500 border-b border-gray-100 sticky top-0 z-10 shadow-sm"><tr><th class="p-4 text-center w-16">No.</th><th class="p-4 sortable" onclick="window.handleSort('name')">ë‹‰ë„¤ì„${sortIcon('name')}</th><th class="p-4 sortable" onclick="window.handleSort('mainInfo')">ë³¸ìº ì •ë³´${sortIcon('mainInfo')}</th><th class="p-4 sortable" onclick="window.handleSort('guild')">ì†Œì†${sortIcon('guild')}</th><th class="p-4 sortable" onclick="window.handleSort('role')">ì§ìœ„${sortIcon('role')}</th><th class="p-4 sortable" onclick="window.handleSort('class')">ì§ì—…${sortIcon('class')}</th></tr></thead><tbody class="divide-y divide-gray-50 text-gray-600 font-bold relative z-0">`;
                
                pageData.forEach((m, idx) => {
                    const globalIndex = (appState.pagination.members - 1) * ITEMS_PER_PAGE + idx + 1;
                    const mainName = m.isMain ? m.name : (m.mainCharName || '-'); 
                    const mainMem = appState.members.find(x => x.name === mainName);
                    const mainRankHtml = mainMem ? formatRankWithSuffix(mainMem.role) : '-';
                    
                    let mainInfoStyle = "";
                    let mainInfoTextClass = "text-gray-700";
                    let subInfoTextClass = "text-gray-400";
                    
                    const targetRole = mainMem ? mainMem.role : (m.isMain ? m.role : '');
                    if (['í‹°ë¼ë¯¸ìŠˆ', 'íŒŒë¥´í˜', 'í¬ë¼ìš´'].includes(targetRole)) {
                        mainInfoStyle = "background-color: #0066FF;";
                        mainInfoTextClass = "text-white";
                        subInfoTextClass = "text-white opacity-80";
                    } else if (targetRole === 'í¬ë¡œì¹¸ìŠˆ') {
                        mainInfoStyle = "background-color: #92D050;";
                        mainInfoTextClass = "text-black";
                        subInfoTextClass = "text-black opacity-80";
                    }

                    let roleHtml = `<span class="text-[10px]">${m.role}</span>`;
                    if (m.role === 'ì•„ì¸ìŠˆí˜ë„ˆ') {
                        roleHtml = `<span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold text-white tracking-tight shadow-sm" style="background-color: #FF99FF; text-shadow: 0 1px 1px rgba(0,0,0,0.1);">${m.role}</span>`;
                    }

                    html += `<tr class="hover:bg-pink-50/20 group transition-colors h-12">
                        <td class="p-3 text-center text-gray-400 text-[11px]">${globalIndex}</td>
                        <td class="p-3 font-bold text-gray-800 flex items-center h-full leading-none">${window.getNicknameIcon(m.role)}<span class="text-sm tracking-tight">${m.name}</span></td>
                        <td class="p-3 leading-tight">
                            <div class="rounded-xl p-2 transition-colors -m-1" style="${mainInfoStyle}">
                                <span class="block text-[11px] font-bold ${mainInfoTextClass}">${mainName}</span>
                                <span class="text-[9px] font-medium ${subInfoTextClass}">${mainRankHtml}</span>
                            </div>
                        </td>
                        <td class="p-3">${m.guild}</td>
                        <td class="p-3">${roleHtml}</td>
                        <td class="p-3"><span class="text-[10px] text-gray-400">${m.class||'-'}</span></td>
                    </tr>`;
                });
                html += `</tbody></table></div>`;
            }
            
            html += `<div class="p-3 border-t border-gray-100 flex justify-center items-center gap-4 bg-gray-50/50 relative z-20">
                <button onclick="changePage('members', -1)" class="w-8 h-8 flex items-center justify-center rounded-xl bg-white border border-gray-200 text-gray-500 hover:bg-pink-50 hover:text-pink-500 hover:border-pink-200 disabled:opacity-30 disabled:hover:bg-white" ${appState.pagination.members <= 1 ? 'disabled' : ''}><i class="fas fa-chevron-left text-[10px]"></i></button>
                <span class="text-xs font-bold text-gray-500">${appState.pagination.members} / ${totalPages || 1}</span>
                <button onclick="changePage('members', 1)" class="w-8 h-8 flex items-center justify-center rounded-xl bg-white border border-gray-200 text-gray-500 hover:bg-pink-50 hover:text-pink-500 hover:border-pink-200 disabled:opacity-30 disabled:hover:bg-white" ${appState.pagination.members >= totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right text-[10px]"></i></button>
            </div>`;

            container.innerHTML = html;
        };

        // --- BAIL (Public view: anonymized payer, no form, no date) ---
        window.renderBail = (container) => {
            const adminStats = window.getAdminBailStats();
            const historyRows = [...appState.bailHistory].reverse().map(h => `<tr class="hover:bg-gray-50 border-b border-gray-50 h-12 transition-colors font-bold text-xs"><td class="p-4 text-gray-400">******</td><td class="p-4 text-blue-500">${h.receiver}</td><td class="p-4 text-right text-pink-500">${h.amount}ê°œ</td></tr>`).join('');
            const statsHtml = adminStats.map(([name, count]) => `<div class="bg-gray-50 rounded-2xl p-4 flex justify-between items-center border border-gray-100 hover:bg-white transition-all shadow-sm"><span class="font-bold text-gray-700 text-xs">${name}</span><span class="font-black text-pink-500 text-lg">${count}ê°œ</span></div>`).join('');
            
            container.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 fade-in h-full">
                <div class="lg:col-span-1 bg-white p-10 rounded-[3rem] border border-gray-100 shadow-sm flex flex-col h-full overflow-hidden">
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-gray-800 tracking-tight">ê°„ë¶€ë³„ ë³´ì„ê¸ˆ ìˆ˜ë ¹ ì´ê³„</h3>
                        <p class="text-xs text-gray-400 mt-1 uppercase font-bold tracking-widest">GEM BAIL SUMMARY</p>
                    </div>
                    <div class="grid grid-cols-1 gap-2 flex-1 overflow-y-auto no-scrollbar">
                        ${statsHtml || '<p class="text-[10px] text-gray-300 italic text-center py-4">ë°ì´í„° ì—†ìŒ</p>'}
                    </div>
                </div>
                <div class="lg:col-span-2 bg-white rounded-[3rem] border border-gray-100 shadow-sm flex flex-col h-full overflow-hidden">
                    <div class="p-8 border-b border-gray-50 flex justify-between items-center">
                        <h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">ë³´ì„ê¸ˆ ë‚´ì—­</h3>
                        <span class="text-[10px] text-gray-400 font-bold italic">Total: ${appState.bailHistory.length}</span>
                    </div>
                    <div class="flex-1 overflow-y-auto no-scrollbar">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-gray-50 text-[10px] font-bold text-gray-500 uppercase sticky top-0 z-20">
                                <tr>
                                    <th class="p-5">ë‚©ë¶€ì</th>
                                    <th class="p-5">ìˆ˜ë ¹ì</th>
                                    <th class="p-5 text-right">ìˆ˜ëŸ‰</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-50 relative z-10">
                                ${historyRows || '<tr><td colspan="3" class="p-20 text-center text-gray-300 font-bold italic">ë‚´ì—­ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        };

        // --- PENALTY (Public view: anonymized name, no date, private reason, no form) ---
        window.renderPenalty = (container) => {
            const penaltyCounts = {};
            appState.penaltyHistory.forEach(h => {
                penaltyCounts[h.name] = (penaltyCounts[h.name] || 0) + Number(h.points);
            });
            const activePenalties = Object.entries(penaltyCounts).filter(([name, pts]) => pts > 0);

            const penaltyRows = [...appState.penaltyHistory].map(h => {
                return `
                <tr class="hover:bg-gray-50 border-b border-gray-50 h-12 transition-colors font-bold text-xs">
                    <td class="p-4 text-gray-400">******</td>
                    <td class="p-4 text-red-500">${h.points}ì </td>
                    <td class="p-4 text-gray-400 text-[11px]">ë¹„ê³µê°œ ì‚¬ìœ </td>
                </tr>
            `}).join('');

            container.innerHTML = `
            <div class="flex flex-col gap-6 fade-in h-full">
                <div class="bg-white p-8 rounded-[3rem] border border-gray-100 shadow-sm shrink-0 min-h-[120px]">
                    <div class="mb-4">
                        <h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">í˜„ì¬ ë²Œì  ê´€ë¦¬ ëŒ€ìƒ</h3>
                        <p class="text-[10px] text-gray-400 mt-1">í˜„ì¬ ë²Œì ì´ ë¶€ì—¬ëœ ì¸ì› ìˆ˜: <span class="text-red-500 font-bold">${activePenalties.length}ëª…</span></p>
                    </div>
                    <div class="flex gap-4 overflow-x-auto no-scrollbar pb-2">
                        ${activePenalties.length > 0 
                            ? activePenalties.map(([name, pts]) => `
                                <div class="flex items-center gap-3 bg-red-50 pl-2 pr-5 py-2 rounded-full border border-red-100 shrink-0">
                                    <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-red-500 font-bold text-xs shadow-sm">${pts}</div>
                                    <span class="text-xs font-bold text-red-600">******</span>
                                </div>
                              `).join('')
                            : '<p class="text-xs text-gray-300 font-bold italic w-full">í˜„ì¬ ë²Œì ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                        }
                    </div>
                </div>

                <div class="bg-white rounded-[3rem] border border-gray-100 shadow-sm flex flex-col flex-1 overflow-hidden h-full">
                    <div class="p-8 border-b border-gray-50 flex justify-between items-center shrink-0">
                        <h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">ë²Œì  ì´ë ¥</h3>
                    </div>
                    <div class="flex-1 overflow-y-auto no-scrollbar">
                        <table class="w-full text-left text-xs whitespace-nowrap">
                            <thead class="bg-gray-50 text-[10px] font-bold text-gray-500 uppercase sticky top-0 z-20">
                                <tr>
                                    <th class="p-5">ëŒ€ìƒì</th>
                                    <th class="p-5">ì ìˆ˜</th>
                                    <th class="p-5">ì‚¬ìœ </th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-50 relative z-10">
                                ${penaltyRows || '<tr><td colspan="3" class="p-20 text-center text-gray-300 font-bold italic">ë²Œì  ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        };

        function initSidebar() {
            const sb = document.getElementById('sidebar'), ov = document.getElementById('sidebarOverlay');
            document.getElementById('openSidebar').onclick = () => { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); };
            document.getElementById('closeSidebar').onclick = () => { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); };
            ov.onclick = () => { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); };
        }

        document.addEventListener('DOMContentLoaded', () => { initSidebar(); window.fetchMembers(); });
    </script>
</body>
</html>
